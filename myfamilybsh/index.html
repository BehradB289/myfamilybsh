<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        body { font-family: 'Vazirmatn', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
    <!-- Import Map for React and Firebase modules -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1",
                "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, 
            query, orderBy, onSnapshot, serverTimestamp, setDoc, getDoc 
        } from 'firebase/firestore';
        import { 
            Home, Calendar, CheckSquare, ShoppingCart, DollarSign, 
            MessageCircle, Wifi, Book, Utensils, Wrench, Repeat, Trash2, 
            ChevronRight, Smartphone, Sun, Moon, HeartPulse, Loader2,
            Clock, CheckCircle2, ArrowUpCircle, Coffee, UtensilsCrossed, Pill,
            TrendingUp, TrendingDown, PieChart, Gavel, Vote, Gift, 
            Image as ImageIcon, Music, Film, BookOpen, ScrollText, Phone, 
            ChefHat, Cookie, Smile, Frown, Gamepad2, Timer, Star, MapPin
        } from 'lucide-react';

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhEB7Kax9LZi_16JcZ7dWyYsUIR6v-y0Y",
            authDomain: "family-app-9da43.firebaseapp.com",
            projectId: "family-app-9da43",
            storageBucket: "family-app-9da43.firebasestorage.app",
            messagingSenderId: "48481240206",
            appId: "1:48481240206:web:cb59f13e5ac7e0ff3b75df",
            measurementId: "G-QPM2GB57Y6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Data ---
        const FAMILY_MEMBERS = [
            { id: 'dad', name: 'Ø¨Ù‡Ø²Ø§Ø¯ (Ù¾Ø¯Ø±)', avatar: 'ğŸ‘¨ğŸ»', color: 'bg-blue-600', ring: 'ring-blue-200' },
            { id: 'mom', name: 'Ø´Ù‡Ø±Ø²Ø§Ø¯ (Ù…Ø§Ø¯Ø±)', avatar: 'ğŸ‘©ğŸ»', color: 'bg-pink-600', ring: 'ring-pink-200' },
            { id: 'behrad', name: 'Ø¨Ù‡Ø±Ø§Ø¯ (Û±Û· Ø³Ø§Ù„Ù‡)', avatar: 'ğŸ§‘ğŸ»', color: 'bg-indigo-600', ring: 'ring-indigo-200' },
            { id: 'shahrad', name: 'Ø´Ù‡Ø±Ø§Ø¯ (Û¹ Ø³Ø§Ù„Ù‡)', avatar: 'ğŸ‘¶ğŸ»', color: 'bg-green-500', ring: 'ring-green-200' },
        ];

        const APPS = [
            { id: 'calendar', name: 'ØªÙ‚ÙˆÛŒÙ… Ùˆ Ø±ÙˆÛŒØ¯Ø§Ø¯', icon: <Calendar />, color: 'bg-purple-500' },
            { id: 'tasks', name: 'Ú©Ø§Ø±Ù‡Ø§ Ùˆ Ø¬Ø§ÛŒØ²Ù‡', icon: <CheckSquare />, color: 'bg-blue-500' },
            { id: 'kitchen', name: 'Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡', icon: <ChefHat />, color: 'bg-orange-500' },
            { id: 'shopping', name: 'Ù„ÛŒØ³Øª Ø®Ø±ÛŒØ¯', icon: <ShoppingCart />, color: 'bg-pink-500' },
            { id: 'finance', name: 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø®Ø§Ø±Ø¬', icon: <DollarSign />, color: 'bg-emerald-500' },
            { id: 'democracy', name: 'Ø´ÙˆØ±Ø§ Ùˆ Ø±Ø£ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ', icon: <Vote />, color: 'bg-cyan-600' },
            { id: 'entertainment', name: 'Ø³Ø±Ú¯Ø±Ù…ÛŒ Ùˆ Ø®Ø§Ø·Ø±Ø§Øª', icon: <Gamepad2 />, color: 'bg-violet-500' },
            { id: 'house', name: 'Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø§Ù†Ù‡', icon: <Home />, color: 'bg-slate-600' },
            { id: 'health', name: 'Ø¯Ø§Ø±Ùˆ Ùˆ Ø³Ù„Ø§Ù…Øª', icon: <HeartPulse />, color: 'bg-red-500' },
            { id: 'journal', name: 'Ø®Ø§Ø·Ø±Ø§Øª Ø±ÙˆØ²Ø§Ù†Ù‡', icon: <Book />, color: 'bg-amber-500' },
            { id: 'chat', name: 'Ú†Øª Ø±ÙˆÙ…', icon: <MessageCircle />, color: 'bg-teal-500' },
        ];

        // --- Main Component ---
        function FamilyOS() {
            const [currentUser, setCurrentUser] = useState(null);
            const [activeApp, setActiveApp] = useState(null);
            const [theme, setTheme] = useState('light');
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userPoints, setUserPoints] = useState(0);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        setIsAuthReady(true);
                    } else {
                        await signInAnonymously(auth);
                    }
                });
                return () => unsubscribe();
            }, []);

            // Sync user points
            useEffect(() => {
                if (currentUser) {
                    const unsub = onSnapshot(doc(db, 'users', currentUser.id), (doc) => {
                        if (doc.exists()) {
                            setUserPoints(doc.data().points || 0);
                        } else {
                            setDoc(doc.ref, { points: 0, name: currentUser.name });
                        }
                    });
                    return () => unsub();
                }
            }, [currentUser]);

            const switchUser = () => {
                setCurrentUser(null);
                setActiveApp(null);
            };

            if (!isAuthReady) return <LoadingScreen />;
            if (!currentUser) return <UserSelectScreen onSelect={setCurrentUser} />;

            return (
                <div className={`h-screen w-full overflow-hidden flex flex-col font-[vazirmatn,sans-serif] ${theme === 'dark' ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-800'}`} dir="rtl">
                    <Header 
                        user={currentUser} 
                        points={userPoints}
                        theme={theme} 
                        setTheme={setTheme} 
                        switchUser={switchUser} 
                        goHome={() => setActiveApp(null)} 
                    />
                    <main className="flex-1 overflow-hidden relative">
                        {activeApp ? (
                            <AppWindow app={activeApp} close={() => setActiveApp(null)} user={currentUser} theme={theme} userPoints={userPoints} />
                        ) : (
                            <Dashboard openApp={setActiveApp} user={currentUser} theme={theme} points={userPoints} />
                        )}
                    </main>
                </div>
            );
        }

        // --- Sub-Components ---

        function LoadingScreen() {
            return (
                <div className="h-screen w-full flex flex-col items-center justify-center bg-slate-50 text-slate-500 gap-4">
                    <Loader2 className="animate-spin text-indigo-600" size={48} />
                    <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Family OS...</p>
                </div>
            );
        }

        function UserSelectScreen({ onSelect }) {
            return (
                <div className="h-screen bg-slate-50 flex flex-col items-center justify-center p-6 relative overflow-hidden">
                    <div className="text-center w-full max-w-3xl">
                        <h1 className="text-3xl font-black text-slate-800 mb-2">Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ Ù…Ø§ â¤ï¸</h1>
                        <p className="text-slate-500 mb-10">Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø±ÙˆÛŒ Ø¹Ú©Ø³ Ø®ÙˆØ¯ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            {FAMILY_MEMBERS.map((member) => (
                                <button key={member.id} onClick={() => onSelect(member)} className="bg-white p-4 py-8 rounded-3xl border border-slate-100 shadow-xl hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 flex flex-col items-center gap-4 group">
                                    <div className={`w-20 h-20 rounded-full ${member.color} flex items-center justify-center text-4xl shadow-lg ring-4 ring-offset-2 ${member.ring} group-hover:scale-110 transition-transform`}>
                                        {member.avatar}
                                    </div>
                                    <span className="font-bold text-slate-700 group-hover:text-indigo-600">{member.name.split(' ')[0]}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function Header({ user, points, theme, setTheme, switchUser, goHome }) {
            return (
                <header className={`px-6 py-4 flex justify-between items-center z-20 ${theme === 'dark' ? 'bg-slate-800/50' : 'bg-white/80'} backdrop-blur-md sticky top-0 border-b border-slate-200/50`}>
                    <div className="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity" onClick={goHome}>
                        <div className="w-10 h-10 bg-gradient-to-tr from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                            <Home size={20} />
                        </div>
                        <div>
                            <h1 className="font-black text-lg leading-tight">Family OS</h1>
                            <p className="text-xs opacity-60 font-medium">Ù¾Ù†Ù„ {user.name.split(' ')[0]}</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-3">
                        <div className="hidden md:flex items-center gap-1 bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-xs font-bold border border-amber-200">
                            <Star size={14} fill="currentColor" />
                            <span>{points} Ø§Ù…ØªÛŒØ§Ø²</span>
                        </div>
                        <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className="p-2 rounded-full hover:bg-slate-200/50 transition-colors">
                            {theme === 'dark' ? <Sun size={20} /> : <Moon size={20} />}
                        </button>
                        <button onClick={switchUser} className="flex items-center gap-2 bg-slate-200/50 hover:bg-red-100 text-slate-600 hover:text-red-600 px-3 py-1.5 rounded-full transition-all text-xs font-bold">
                            <Repeat size={14} />
                            <span className="hidden md:inline">Ø®Ø±ÙˆØ¬</span>
                        </button>
                        <div className={`w-10 h-10 rounded-full ${user.color} p-0.5 border-2 border-white shadow-md flex items-center justify-center text-xl overflow-hidden`}>
                            {user.avatar}
                        </div>
                    </div>
                </header>
            );
        }

        function Dashboard({ openApp, user, theme, points }) {
            const [time, setTime] = useState(new Date());
            const [financeSummary, setFinanceSummary] = useState({ income: 0, expense: 0 });

            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 60000);
                const unsub = onSnapshot(collection(db, 'finance'), (snap) => {
                    let inc = 0, exp = 0;
                    snap.docs.forEach(doc => {
                        const d = doc.data();
                        if (d.type === 'income') inc += d.amount;
                        else exp += d.amount;
                    });
                    setFinanceSummary({ income: inc, expense: exp });
                });
                return () => { clearInterval(timer); unsub(); }
            }, []);

            const total = Math.max(financeSummary.income + financeSummary.expense, 1);

            return (
                <div className="h-full overflow-y-auto p-4 md:p-8 space-y-8 animate-fade-in pb-24">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className={`md:col-span-2 p-6 rounded-3xl ${theme === 'dark' ? 'bg-indigo-900/40 border-indigo-500/30' : 'bg-white border-indigo-100'} border shadow-xl shadow-indigo-500/5 relative overflow-hidden flex flex-col justify-between`}>
                            <div>
                                <h2 className="text-3xl font-black mb-2">Ø³Ù„Ø§Ù… {user.name.split(' ')[0]} ğŸ‘‹</h2>
                                <p className="opacity-70 text-sm mb-4">Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ Ø¨Ù‡ Ø®ÙˆÙ†Ù‡ Ù…Ø¬Ø§Ø²ÛŒ!</p>
                                <div className="bg-slate-100/50 p-3 rounded-xl mb-4">
                                    <div className="flex justify-between text-xs mb-1 font-bold">
                                        <span className="text-emerald-600">Ø¯Ø±Ø¢Ù…Ø¯: {financeSummary.income.toLocaleString()}</span>
                                        <span className="text-rose-600">Ù‡Ø²ÛŒÙ†Ù‡: {financeSummary.expense.toLocaleString()}</span>
                                    </div>
                                    <div className="w-full h-3 bg-slate-200 rounded-full overflow-hidden flex">
                                        <div style={{ width: `${(financeSummary.income / total) * 100}%` }} className="h-full bg-emerald-500"></div>
                                        <div style={{ width: `${(financeSummary.expense / total) * 100}%` }} className="h-full bg-rose-500"></div>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-3 mt-2">
                                <button onClick={() => openApp('tasks')} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 flex-1 md:flex-none flex items-center justify-center gap-2">
                                    <CheckSquare size={16}/> Ú©Ø§Ø±Ù‡Ø§ÛŒ Ù…Ù†
                                </button>
                                <button onClick={() => openApp('democracy')} className="bg-cyan-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-cyan-200 flex-1 md:flex-none flex items-center justify-center gap-2">
                                    <Vote size={16}/> Ø±Ø£ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ
                                </button>
                            </div>
                        </div>
                        <div className={`p-6 rounded-3xl flex flex-col justify-between ${theme === 'dark' ? 'bg-slate-800' : 'bg-slate-800'} text-white shadow-lg`}>
                            <div className="flex justify-between">
                                <span className="opacity-50 text-sm">Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§</span>
                                <Star className="text-yellow-400" fill="currentColor" />
                            </div>
                            <div>
                                <p className="text-5xl font-bold mt-2" dir="ltr">{points}</p>
                                <p className="text-xs opacity-50 mt-1">Ø§Ù…ØªÛŒØ§Ø² Ù‚Ø§Ø¨Ù„ Ø®Ø±Ø¬</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 className="font-bold text-xl mb-4 opacity-80 flex items-center gap-2"><PieChart size={20} /> Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§</h3>
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            {APPS.map(app => (
                                <button key={app.id} onClick={() => openApp(app.id)} className={`p-4 rounded-2xl flex flex-col items-center gap-3 transition-all duration-300 hover:scale-105 hover:shadow-lg ${theme === 'dark' ? 'bg-slate-800 hover:bg-slate-700' : 'bg-white hover:bg-indigo-50'} border border-transparent hover:border-indigo-200`}>
                                    <div className={`w-14 h-14 rounded-2xl ${app.color} text-white flex items-center justify-center shadow-lg shadow-${app.color.replace('bg-', '')}/30`}>
                                        {React.cloneElement(app.icon, { size: 28 })}
                                    </div>
                                    <span className="font-bold text-sm text-center">{app.name}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function AppWindow({ app: appId, close, user, theme, userPoints }) {
            const appData = APPS.find(a => a.id === appId);
            return (
                <div className={`absolute inset-0 z-30 flex flex-col ${theme === 'dark' ? 'bg-slate-900' : 'bg-slate-50'} animate-slide-up`}>
                    <div className={`px-6 py-4 flex items-center justify-between ${theme === 'dark' ? 'bg-slate-800' : 'bg-white'} border-b border-slate-200 shadow-sm sticky top-0 z-10`}>
                        <div className="flex items-center gap-3">
                            <button onClick={close} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><ChevronRight size={24} /></button>
                            <div className={`w-10 h-10 rounded-xl ${appData.color} flex items-center justify-center text-white`}>{appData.icon}</div>
                            <h2 className="text-xl font-bold">{appData.name}</h2>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 md:p-8">
                        {appId === 'calendar' && <CalendarApp user={user} />}
                        {appId === 'tasks' && <TasksApp user={user} points={userPoints} />}
                        {appId === 'kitchen' && <KitchenApp user={user} />}
                        {appId === 'shopping' && <ShoppingApp user={user} />}
                        {appId === 'finance' && <FinanceApp user={user} />}
                        {appId === 'democracy' && <DemocracyApp user={user} />}
                        {appId === 'entertainment' && <EntertainmentApp user={user} />}
                        {appId === 'house' && <HouseApp user={user} />}
                        {appId === 'health' && <HealthApp user={user} />}
                        {appId === 'journal' && <JournalApp user={user} />}
                        {appId === 'chat' && <ChatApp user={user} />}
                    </div>
                </div>
            );
        }

        // --- Apps Implementations ---

        function DemocracyApp({ user }) {
            const [tab, setTab] = useState('poll');
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                        <button onClick={() => setTab('poll')} className={`px-4 py-2 rounded-xl whitespace-nowrap font-bold ${tab === 'poll' ? 'bg-cyan-600 text-white' : 'bg-white'}`}>ğŸ—³ï¸ Ø±Ø£ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ</button>
                        <button onClick={() => setTab('court')} className={`px-4 py-2 rounded-xl whitespace-nowrap font-bold ${tab === 'court' ? 'bg-cyan-600 text-white' : 'bg-white'}`}>âš–ï¸ Ø¯Ø§Ø¯Ú¯Ø§Ù‡ Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</button>
                        <button onClick={() => setTab('suggest')} className={`px-4 py-2 rounded-xl whitespace-nowrap font-bold ${tab === 'suggest' ? 'bg-cyan-600 text-white' : 'bg-white'}`}>ğŸ’¡ ØµÙ†Ø¯ÙˆÙ‚ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª</button>
                    </div>
                    {tab === 'poll' && <PollingSystem user={user} />}
                    {tab === 'court' && <FamilyCourt user={user} />}
                    {tab === 'suggest' && <SuggestionBox user={user} />}
                </div>
            );
        }

        function PollingSystem({ user }) {
            const [polls, setPolls] = useState([]);
            const [newPoll, setNewPoll] = useState('');
            const [options, setOptions] = useState(['', '']);

            useEffect(() => {
                return onSnapshot(query(collection(db, 'polls'), orderBy('createdAt', 'desc')), (snap) => {
                    setPolls(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });
            }, []);

            const createPoll = async (e) => {
                e.preventDefault();
                if(!newPoll || options.some(o => !o)) return;
                await addDoc(collection(db, 'polls'), {
                    question: newPoll,
                    options: options.map(o => ({ text: o, votes: [] })),
                    createdBy: user.name,
                    createdAt: serverTimestamp(),
                    isActive: true
                });
                setNewPoll(''); setOptions(['', '']);
            };

            const vote = async (poll, optionIndex) => {
                const updatedOptions = [...poll.options];
                // Remove previous vote
                updatedOptions.forEach(opt => {
                    if(opt.votes.includes(user.id)) opt.votes = opt.votes.filter(id => id !== user.id);
                });
                // Add new vote
                updatedOptions[optionIndex].votes.push(user.id);
                await updateDoc(doc(db, 'polls', poll.id), { options: updatedOptions });
            };

            return (
                <div className="space-y-6">
                    <form onSubmit={createPoll} className="bg-white p-4 rounded-xl shadow-sm border space-y-3">
                        <h3 className="font-bold text-lg">Ø§ÛŒØ¬Ø§Ø¯ Ø±Ø£ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
                        <input value={newPoll} onChange={e=>setNewPoll(e.target.value)} placeholder="Ø³ÙˆØ§Ù„ (Ù…Ø«Ù„Ø§: Ø´Ø§Ù… Ú†ÛŒ Ø¨Ø®ÙˆØ±ÛŒÙ…ØŸ)" className="w-full p-2 border rounded-lg" />
                        <div className="flex gap-2">
                            {options.map((opt, i) => (
                                <input key={i} value={opt} onChange={e=>{const newO = [...options]; newO[i]=e.target.value; setOptions(newO)}} placeholder={`Ú¯Ø²ÛŒÙ†Ù‡ ${i+1}`} className="flex-1 p-2 border rounded-lg" />
                            ))}
                        </div>
                        <button className="bg-cyan-600 text-white w-full py-2 rounded-lg font-bold">Ø´Ø±ÙˆØ¹ Ø±Ø£ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ</button>
                    </form>
                    <div className="grid gap-4">
                        {polls.map(poll => (
                            <div key={poll.id} className="bg-white p-5 rounded-xl border shadow-sm">
                                <div className="flex justify-between mb-4">
                                    <h4 className="font-bold text-lg">{poll.question}</h4>
                                    <button onClick={()=>deleteDoc(doc(db, 'polls', poll.id))} className="text-slate-300 hover:text-red-500"><Trash2 size={16}/></button>
                                </div>
                                <div className="space-y-2">
                                    {poll.options.map((opt, idx) => {
                                        const totalVotes = poll.options.reduce((acc, curr) => acc + curr.votes.length, 0);
                                        const percent = totalVotes === 0 ? 0 : Math.round((opt.votes.length / totalVotes) * 100);
                                        const isSelected = opt.votes.includes(user.id);
                                        return (
                                            <div key={idx} onClick={()=>vote(poll, idx)} className={`relative p-3 rounded-lg border cursor-pointer overflow-hidden ${isSelected ? 'border-cyan-500 ring-1 ring-cyan-500' : 'border-slate-200 hover:bg-slate-50'}`}>
                                                <div className="absolute inset-0 bg-cyan-50 transition-all duration-500" style={{ width: `${percent}%`, opacity: 0.5 }}></div>
                                                <div className="relative flex justify-between z-10">
                                                    <span>{opt.text}</span>
                                                    <span className="font-bold text-slate-600">{percent}% ({opt.votes.length} Ø±Ø£ÛŒ)</span>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <p className="text-xs text-slate-400 mt-2 text-left">Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· {poll.createdBy}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function FamilyCourt({ user }) {
            const [cases, setCases] = useState([]);
            const [complaint, setComplaint] = useState('');
            const [defendant, setDefendant] = useState('Ø¨Ù‡Ø±Ø§Ø¯ (Ù¾Ø³Ø± Ø§Ø±Ø´Ø¯)');

            useEffect(() => {
                return onSnapshot(query(collection(db, 'court'), orderBy('createdAt', 'desc')), (snap) => setCases(snap.docs.map(d => ({id: d.id, ...d.data()}))) );
            }, []);

            const fileCase = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, 'court'), { plaintiff: user.name, defendant, complaint, verdict: 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø­Ú©Ù… ÙˆØ§Ù„Ø¯ÛŒÙ†', createdAt: serverTimestamp() });
                setComplaint('');
            };

            const issueVerdict = async (id, verdict) => {
                // Only parents can judge (simple check based on name/id for demo)
                if(user.id !== 'dad' && user.id !== 'mom') { alert('ÙÙ‚Ø· Ù…Ø§Ù…Ø§Ù† Ùˆ Ø¨Ø§Ø¨Ø§ Ù‚Ø§Ø¶ÛŒ Ù‡Ø³ØªÙ†Ø¯!'); return; }
                await updateDoc(doc(db, 'court', id), { verdict });
            };

            return (
                <div className="space-y-6">
                    <div className="bg-amber-50 p-4 rounded-xl border border-amber-200 text-center">
                        <Gavel className="mx-auto mb-2 text-amber-800" size={32} />
                        <h3 className="font-bold text-amber-900">Ø¯Ø§Ø¯Ú¯Ø§Ù‡ Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ âš–ï¸</h3>
                        <p className="text-xs text-amber-700">Ø­Ù„ Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø¨Ø§ Ø­Ú©Ù… Ù†Ù‡Ø§ÛŒÛŒ ÙˆØ§Ù„Ø¯ÛŒÙ†</p>
                    </div>
                    <form onSubmit={fileCase} className="bg-white p-4 rounded-xl border space-y-3">
                        <input value={complaint} onChange={e=>setComplaint(e.target.value)} placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø´Ú©Ø§ÛŒØª..." className="w-full p-2 border rounded-lg" />
                        <div className="flex gap-2 items-center">
                            <span className="text-sm font-bold">Ù…ØªÙ‡Ù…:</span>
                            <select value={defendant} onChange={e=>setDefendant(e.target.value)} className="flex-1 p-2 border rounded-lg bg-white">
                                {FAMILY_MEMBERS.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                            </select>
                            <button className="bg-amber-600 text-white px-4 py-2 rounded-lg font-bold">Ø«Ø¨Øª Ø´Ú©Ø§ÛŒØª</button>
                        </div>
                    </form>
                    <div className="space-y-3">
                        {cases.map(c => (
                            <div key={c.id} className="bg-white p-4 rounded-xl border relative">
                                <div className="flex justify-between items-start mb-2">
                                    <h4 className="font-bold text-red-600">Ø´Ø§Ú©ÛŒ: {c.plaintiff} âš¡ Ù…ØªÙ‡Ù…: {c.defendant}</h4>
                                    <button onClick={()=>deleteDoc(doc(db,'court',c.id))}><Trash2 size={16} className="text-slate-300"/></button>
                                </div>
                                <p className="text-slate-700 mb-3 bg-slate-50 p-2 rounded">"{c.complaint}"</p>
                                <div className="flex items-center gap-2 bg-amber-50 p-2 rounded-lg border border-amber-100">
                                    <Gavel size={16} className="text-amber-600"/>
                                    <span className="text-sm font-bold">Ø­Ú©Ù…: </span>
                                    {(user.id === 'dad' || user.id === 'mom') ? (
                                        <input className="flex-1 bg-transparent border-b border-amber-300 outline-none text-sm" defaultValue={c.verdict} onBlur={(e)=>issueVerdict(c.id, e.target.value)} />
                                    ) : (
                                        <span className="text-sm">{c.verdict}</span>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function SuggestionBox({ user }) {
            const [notes, setNotes] = useState([]);
            const [text, setText] = useState('');
            useEffect(() => onSnapshot(query(collection(db, 'suggestions'), orderBy('createdAt', 'desc')), s => setNotes(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!text)return; await addDoc(collection(db, 'suggestions'), { text, author: user.name, createdAt: serverTimestamp() }); setText(''); }
            return (
                <div className="space-y-4">
                    <form onSubmit={add} className="flex gap-2"><input value={text} onChange={e=>setText(e.target.value)} placeholder="Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ (Ø³ÙØ±ØŒ Ø®Ø±ÛŒØ¯ØŒ Ø§ÛŒØ¯Ù‡...)" className="flex-1 p-3 border rounded-xl" /><button className="bg-cyan-600 text-white px-4 rounded-xl"><ArrowUpCircle/></button></form>
                    <div className="grid gap-3">{notes.map(n => <div key={n.id} className="bg-white p-3 rounded-xl border shadow-sm flex justify-between"><span>{n.text}</span><span className="text-xs text-slate-400">{n.author}</span></div>)}</div>
                </div>
            )
        }

        function TasksApp({ user, points }) {
            const [tab, setTab] = useState('tasks');
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex justify-between items-center mb-6">
                         <div className="flex gap-2">
                            <button onClick={() => setTab('tasks')} className={`px-4 py-2 rounded-xl font-bold ${tab === 'tasks' ? 'bg-blue-600 text-white' : 'bg-white'}`}>ğŸ“ ÙˆØ¸Ø§ÛŒÙ</button>
                            <button onClick={() => setTab('shop')} className={`px-4 py-2 rounded-xl font-bold ${tab === 'shop' ? 'bg-blue-600 text-white' : 'bg-white'}`}>ğŸ›ï¸ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¬Ø§ÛŒØ²Ù‡</button>
                        </div>
                        <div className="bg-yellow-100 text-yellow-700 px-4 py-2 rounded-xl font-bold flex items-center gap-2">
                            <Star fill="currentColor" size={16}/> {points} Ø³Ú©Ù‡
                        </div>
                    </div>
                    {tab === 'tasks' ? <TaskList user={user} /> : <RewardStore user={user} points={points} />}
                </div>
            );
        }

        function TaskList({ user }) {
            const [tasks, setTasks] = useState([]);
            const [newTask, setNewTask] = useState('');
            const [assignee, setAssignee] = useState(user.name);
            const [reward, setReward] = useState('10');

            useEffect(() => {
                return onSnapshot(query(collection(db, 'tasks'), orderBy('createdAt', 'desc')), (snap) => setTasks(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            }, []);

            const addTask = async (e) => {
                e.preventDefault();
                if(!newTask) return;
                await addDoc(collection(db, 'tasks'), { title: newTask, assignee, reward: parseInt(reward), isDone: false, createdBy: user.name, createdAt: serverTimestamp() });
                setNewTask('');
            };

            const toggleTask = async (task) => {
                if (!task.isDone) {
                    if(user.name === task.assignee) {
                        const userRef = doc(db, 'users', user.id);
                        const uDoc = await getDoc(userRef);
                        const currentPoints = uDoc.exists() ? uDoc.data().points || 0 : 0;
                        await setDoc(userRef, { points: currentPoints + task.reward }, { merge: true });
                    }
                }
                await updateDoc(doc(db, 'tasks', task.id), { isDone: !task.isDone });
            };

            return (
                <div className="space-y-4">
                    <form onSubmit={addTask} className="bg-white p-4 rounded-xl border space-y-3">
                        <div className="flex gap-2">
                            <input value={newTask} onChange={e=>setNewTask(e.target.value)} placeholder="Ø¹Ù†ÙˆØ§Ù† ÙˆØ¸ÛŒÙÙ‡..." className="flex-1 p-2 border rounded-lg" />
                        </div>
                        <div className="flex gap-2">
                            <select value={assignee} onChange={e=>setAssignee(e.target.value)} className="flex-1 p-2 border rounded-lg bg-white text-sm">
                                {FAMILY_MEMBERS.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                            </select>
                            <select value={reward} onChange={e=>setReward(e.target.value)} className="w-24 p-2 border rounded-lg bg-white text-sm">
                                <option value="10">Û±Û° Ø³Ú©Ù‡</option>
                                <option value="20">Û²Û° Ø³Ú©Ù‡</option>
                                <option value="50">ÛµÛ° Ø³Ú©Ù‡</option>
                            </select>
                            <button className="bg-blue-600 text-white px-4 rounded-lg font-bold text-sm">Ø§ÙØ²ÙˆØ¯Ù†</button>
                        </div>
                    </form>
                    <div className="space-y-2">
                        {tasks.map(t => (
                            <div key={t.id} className={`flex justify-between items-center p-4 bg-white border rounded-xl ${t.isDone ? 'opacity-60 bg-slate-50' : 'hover:border-blue-300'} transition-all`}>
                                <div className="flex items-center gap-4">
                                    <button onClick={() => toggleTask(t)} disabled={t.isDone} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${t.isDone ? 'bg-green-500 border-green-500' : 'border-slate-300'}`}>
                                        {t.isDone && <CheckSquare size={14} className="text-white"/>}
                                    </button>
                                    <div>
                                        <p className={`font-bold ${t.isDone ? 'line-through text-slate-400' : 'text-slate-800'}`}>{t.title}</p>
                                        <div className="flex items-center gap-2 text-xs text-slate-500 mt-1">
                                            <span className="bg-slate-100 px-2 py-0.5 rounded">{t.assignee}</span>
                                            <span className="text-amber-500 font-bold">{t.reward} Ø³Ú©Ù‡</span>
                                        </div>
                                    </div>
                                </div>
                                <button onClick={() => deleteDoc(doc(db, 'tasks', t.id))}><Trash2 size={18} className="text-slate-300 hover:text-red-500"/></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function RewardStore({ user, points }) {
            // New "All-Pleasing" Rewards
            const rewards = [
                { id: 1, title: 'Ù…Ø¹Ø§ÙÛŒØª Ø§Ø² Ù†Ø¸Ø§ÙØª', cost: 60, icon: 'ğŸ§¹' },
                { id: 2, title: 'Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø§Ù… Ø§Ù…Ø´Ø¨', cost: 40, icon: 'ğŸ•' },
                { id: 3, title: 'Ø¨Ø³ØªÙ†ÛŒ/Ø¢Ø¨Ù…ÛŒÙˆÙ‡', cost: 20, icon: 'ğŸ¦' },
                { id: 4, title: 'Û± Ø³Ø§Ø¹Øª Ø®ÙˆØ§Ø¨ Ø¨ÛŒØ´ØªØ±', cost: 30, icon: 'ğŸ˜´' },
                { id: 5, title: 'Ú©Ù†ØªØ±Ù„ ØªÙ„ÙˆÛŒØ²ÛŒÙˆÙ†', cost: 30, icon: 'ğŸ“º' },
                { id: 6, title: 'Ù…Ø¹Ø§ÙÛŒØª Ø§Ø² Ø®Ø±ÛŒØ¯', cost: 50, icon: 'ğŸ›ï¸' },
                { id: 7, title: 'Ø§Ù†ØªØ®Ø§Ø¨ ÙÛŒÙ„Ù…', cost: 25, icon: 'ğŸ¬' },
                { id: 8, title: 'Ú©Ø§Ø±Øª Ù‡Ø¯ÛŒÙ‡ Ù†Øª', cost: 80, icon: 'ğŸŒ' },
            ];

            const buy = async (cost) => {
                if(points >= cost) {
                    await updateDoc(doc(db, 'users', user.id), { points: points - cost });
                    alert('Ø®Ø±ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯! ğŸ‰');
                } else {
                    alert('Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª! ğŸ˜”');
                }
            };

            return (
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {rewards.map(r => (
                        <div key={r.id} className="bg-white p-4 rounded-2xl border shadow-sm flex flex-col items-center text-center gap-3 hover:-translate-y-1 transition-transform">
                            <div className="text-4xl mb-2">{r.icon}</div>
                            <h4 className="font-bold text-sm h-10">{r.title}</h4>
                            <button onClick={()=>buy(r.cost)} className={`w-full py-2 rounded-lg font-bold text-xs ${points >= r.cost ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-400'}`}>
                                Ø®Ø±ÛŒØ¯ ({r.cost} Ø³Ú©Ù‡)
                            </button>
                        </div>
                    ))}
                </div>
            );
        }

        function KitchenApp({ user }) {
            const [tab, setTab] = useState('plan');
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex gap-2 mb-6">
                        <button onClick={() => setTab('plan')} className={`flex-1 py-2 rounded-xl font-bold ${tab === 'plan' ? 'bg-orange-500 text-white' : 'bg-white'}`}>ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ù‡ ØºØ°Ø§ÛŒÛŒ</button>
                        <button onClick={() => setTab('cook')} className={`flex-1 py-2 rounded-xl font-bold ${tab === 'cook' ? 'bg-orange-500 text-white' : 'bg-white'}`}>ğŸ“– Ú©ØªØ§Ø¨ Ø¢Ø´Ù¾Ø²ÛŒ</button>
                        <button onClick={() => setTab('crave')} className={`flex-1 py-2 rounded-xl font-bold ${tab === 'crave' ? 'bg-orange-500 text-white' : 'bg-white'}`}>ğŸ˜‹ Ù‡ÙˆØ³â€ŒØ§Ù†Ú¯ÛŒØ²Ù‡Ø§</button>
                    </div>
                    {tab === 'plan' && <WeeklyMealPlan />}
                    {tab === 'cook' && <Cookbook user={user} />}
                    {tab === 'crave' && <CravingsList user={user} />}
                </div>
            );
        }

        function WeeklyMealPlan() {
            const [meals, setMeals] = useState({});
            const week = ['Ø´Ù†Ø¨Ù‡', 'ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡'];
            useEffect(() => onSnapshot(collection(db, 'meals'), (snap) => { const d={}; snap.forEach(x=>d[x.id]=x.data()); setMeals(d); }), []);
            const up = (d, t, v) => setDoc(doc(db, 'meals', d), { ...meals[d], [t]: v }, { merge: true });
            return (
                <div className="space-y-3">
                    {week.map(day => (
                        <div key={day} className="bg-white p-3 rounded-xl border flex flex-col md:flex-row gap-3 items-center">
                            <div className="w-20 font-bold text-slate-700">{day}</div>
                            <div className="flex-1 w-full grid grid-cols-2 gap-2">
                                <div className="bg-orange-50 p-2 rounded-lg flex gap-2 items-center">
                                    <Utensils size={14} className="text-orange-400"/>
                                    <input value={meals[day]?.lunch||''} onChange={e=>up(day,'lunch',e.target.value)} placeholder="Ù†Ø§Ù‡Ø§Ø±" className="bg-transparent w-full text-sm outline-none"/>
                                </div>
                                <div className="bg-indigo-50 p-2 rounded-lg flex gap-2 items-center">
                                    <UtensilsCrossed size={14} className="text-indigo-400"/>
                                    <input value={meals[day]?.dinner||''} onChange={e=>up(day,'dinner',e.target.value)} placeholder="Ø´Ø§Ù…" className="bg-transparent w-full text-sm outline-none"/>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            )
        }

        function Cookbook({ user }) {
            const [recipes, setRecipes] = useState([]);
            const [newR, setNewR] = useState({ title: '', text: '' });
            useEffect(() => onSnapshot(query(collection(db, 'recipes')), s => setRecipes(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!newR.title)return; await addDoc(collection(db, 'recipes'), newR); setNewR({title:'',text:''}); }
            return (
                <div className="space-y-4">
                    <form onSubmit={add} className="bg-white p-4 rounded-xl border space-y-2">
                        <input value={newR.title} onChange={e=>setNewR({...newR, title: e.target.value})} placeholder="Ù†Ø§Ù… ØºØ°Ø§" className="w-full p-2 border rounded-lg" />
                        <textarea value={newR.text} onChange={e=>setNewR({...newR, text: e.target.value})} placeholder="Ø¯Ø³ØªÙˆØ± Ù¾Ø®Øª..." className="w-full p-2 border rounded-lg h-20" />
                        <button className="bg-orange-500 text-white w-full py-2 rounded-lg font-bold">Ø«Ø¨Øª Ø¯Ø³ØªÙˆØ±</button>
                    </form>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {recipes.map(r => (
                            <div key={r.id} className="bg-white p-4 rounded-xl border relative">
                                <h4 className="font-bold text-orange-700 mb-2">{r.title}</h4>
                                <p className="text-sm text-slate-600 whitespace-pre-wrap">{r.text}</p>
                                <button onClick={()=>deleteDoc(doc(db,'recipes',r.id))} className="absolute top-2 left-2 text-slate-300 hover:text-red-500"><Trash2 size={16}/></button>
                            </div>
                        ))}
                    </div>
                </div>
            )
        }

        function CravingsList({ user }) {
            const [list, setList] = useState([]);
            const [item, setItem] = useState('');
            useEffect(() => onSnapshot(collection(db, 'cravings'), s => setList(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!item)return; await addDoc(collection(db, 'cravings'), { text: item, by: user.name }); setItem(''); }
            return (
                <div className="space-y-4">
                    <form onSubmit={add} className="flex gap-2"><input value={item} onChange={e=>setItem(e.target.value)} placeholder="Ù‡ÙˆØ³ Ú†ÛŒ Ú©Ø±Ø¯ÛŒØŸ (Ù¾ÛŒØªØ²Ø§ØŒ Ù„ÙˆØ§Ø´Ú©...)" className="flex-1 p-3 border rounded-xl" /><button className="bg-orange-500 text-white px-4 rounded-xl">+</button></form>
                    <div className="flex flex-wrap gap-2">
                        {list.map(l => (
                            <div key={l.id} className="bg-white px-4 py-2 rounded-full border shadow-sm flex items-center gap-2">
                                <span>{l.text}</span>
                                <span className="text-[10px] bg-slate-100 px-1 rounded">{l.by}</span>
                                <button onClick={()=>deleteDoc(doc(db,'cravings',l.id))} className="text-slate-300 hover:text-red-500">Ã—</button>
                            </div>
                        ))}
                    </div>
                </div>
            )
        }

        function EntertainmentApp({ user }) {
            const [tab, setTab] = useState('gallery');
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                        <button onClick={() => setTab('gallery')} className={`px-4 py-2 rounded-xl font-bold whitespace-nowrap ${tab === 'gallery' ? 'bg-violet-600 text-white' : 'bg-white'}`}>ğŸ“¸ Ú¯Ø§Ù„Ø±ÛŒ Ùˆ Ù†Ù‚Ø§Ø´ÛŒ</button>
                        <button onClick={() => setTab('reviews')} className={`px-4 py-2 rounded-xl font-bold whitespace-nowrap ${tab === 'reviews' ? 'bg-violet-600 text-white' : 'bg-white'}`}>ğŸ¬ ÙÛŒÙ„Ù… Ùˆ Ú©ØªØ§Ø¨</button>
                        <button onClick={() => setTab('timeline')} className={`px-4 py-2 rounded-xl font-bold whitespace-nowrap ${tab === 'timeline' ? 'bg-violet-600 text-white' : 'bg-white'}`}>â³ ØªØ§ÛŒÙ…â€ŒÙ„Ø§ÛŒÙ†</button>
                    </div>
                    {tab === 'gallery' && <Gallery user={user} />}
                    {tab === 'reviews' && <Reviews user={user} />}
                    {tab === 'timeline' && <Timeline />}
                </div>
            );
        }

        function Gallery({ user }) {
            // Simplified gallery: In a real app we'd use Storage. Here we use URLs or text descriptions.
            const [items, setItems] = useState([]);
            const [url, setUrl] = useState('');
            const [caption, setCaption] = useState('');
            useEffect(() => onSnapshot(query(collection(db, 'gallery'), orderBy('createdAt', 'desc')), s => setItems(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!url)return; await addDoc(collection(db, 'gallery'), { url, caption, by: user.name, createdAt: serverTimestamp() }); setUrl(''); setCaption(''); }
            return (
                <div className="space-y-4">
                    <form onSubmit={add} className="bg-white p-4 rounded-xl border space-y-2">
                        <input value={url} onChange={e=>setUrl(e.target.value)} placeholder="Ù„ÛŒÙ†Ú© Ø¹Ú©Ø³ (ÛŒØ§ Ù…ØªÙ† Ø®Ø§Ø·Ø±Ù‡)" className="w-full p-2 border rounded-lg" dir="ltr" />
                        <input value={caption} onChange={e=>setCaption(e.target.value)} placeholder="ØªÙˆØ¶ÛŒØ­ Ø¹Ú©Ø³..." className="w-full p-2 border rounded-lg" />
                        <button className="bg-violet-600 text-white w-full py-2 rounded-lg font-bold">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¯ÛŒÙˆØ§Ø± Ø®Ø§Ø·Ø±Ø§Øª</button>
                    </form>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        {items.map(item => (
                            <div key={item.id} className="bg-white p-2 rounded-xl border shadow-sm group relative">
                                <div className="aspect-square bg-slate-100 rounded-lg flex items-center justify-center overflow-hidden text-slate-400">
                                    {item.url.startsWith('http') ? <img src={item.url} className="w-full h-full object-cover" onError={(e)=>e.target.src='https://via.placeholder.com/300?text=Error'} /> : <span className="p-4 text-center text-sm">{item.url}</span>}
                                </div>
                                <p className="mt-2 font-bold text-sm px-1">{item.caption}</p>
                                <p className="text-xs text-slate-400 px-1">{item.by}</p>
                                <button onClick={()=>deleteDoc(doc(db,'gallery',item.id))} className="absolute top-2 right-2 bg-white/80 p-1 rounded-full text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={14}/></button>
                            </div>
                        ))}
                    </div>
                </div>
            )
        }

        function Reviews({ user }) {
            const [items, setItems] = useState([]);
            const [newI, setNewI] = useState({ title: '', type: 'movie', rate: '5' });
            useEffect(() => onSnapshot(query(collection(db, 'reviews'), orderBy('createdAt', 'desc')), s => setItems(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!newI.title)return; await addDoc(collection(db, 'reviews'), { ...newI, by: user.name, createdAt: serverTimestamp() }); setNewI({...newI, title: ''}); }
            return (
                <div className="space-y-4">
                    <form onSubmit={add} className="bg-white p-4 rounded-xl border flex gap-2 flex-wrap">
                        <select value={newI.type} onChange={e=>setNewI({...newI, type: e.target.value})} className="p-2 border rounded-lg bg-white"><option value="movie">ÙÛŒÙ„Ù… ğŸ¬</option><option value="book">Ú©ØªØ§Ø¨ ğŸ“š</option></select>
                        <input value={newI.title} onChange={e=>setNewI({...newI, title: e.target.value})} placeholder="Ù†Ø§Ù… Ø§Ø«Ø±..." className="flex-1 p-2 border rounded-lg" />
                        <select value={newI.rate} onChange={e=>setNewI({...newI, rate: e.target.value})} className="p-2 border rounded-lg bg-white"><option>5</option><option>4</option><option>3</option><option>2</option><option>1</option></select>
                        <button className="bg-violet-600 text-white px-4 rounded-lg font-bold">+</button>
                    </form>
                    <div className="space-y-2">
                        {items.map(i => (
                            <div key={i.id} className="bg-white p-3 rounded-xl border flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className="text-2xl">{i.type === 'movie' ? 'ğŸ¬' : 'ğŸ“š'}</div>
                                    <div>
                                        <h4 className="font-bold">{i.title}</h4>
                                        <p className="text-xs text-slate-500">{i.by} â€¢ {i.rate} â­</p>
                                    </div>
                                </div>
                                <button onClick={()=>deleteDoc(doc(db,'reviews',i.id))}><Trash2 size={16} className="text-slate-300"/></button>
                            </div>
                        ))}
                    </div>
                </div>
            )
        }

        function Timeline() {
            // Updated: Dynamic Timeline
            const [events, setEvents] = useState([]);
            const [year, setYear] = useState('');
            const [title, setTitle] = useState('');
            
            useEffect(() => {
                // sort by year string basic
                return onSnapshot(collection(db, 'timeline'), s => {
                    const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                    data.sort((a,b) => a.year.localeCompare(b.year));
                    setEvents(data);
                });
            }, []);

            const add = async (e) => {
                e.preventDefault();
                if(!year || !title) return;
                await addDoc(collection(db, 'timeline'), { year, title });
                setYear(''); setTitle('');
            };

            return (
                <div className="space-y-4">
                     <form onSubmit={add} className="flex gap-2 bg-white p-3 rounded-xl border">
                         <input value={year} onChange={e=>setYear(e.target.value)} placeholder="Ø³Ø§Ù„ (Ù…Ø«Ù„Ø§ Û±Û´Û°Û²)" className="w-24 p-2 border rounded-lg text-center"/>
                         <input value={title} onChange={e=>setTitle(e.target.value)} placeholder="Ú†Ù‡ Ø§ØªÙØ§Ù‚ÛŒ Ø§ÙØªØ§Ø¯ØŸ" className="flex-1 p-2 border rounded-lg"/>
                         <button className="bg-violet-600 text-white px-4 rounded-lg font-bold">+</button>
                     </form>
                     <div className="relative border-r-2 border-violet-200 mr-4 space-y-8 py-4">
                        {events.map((e, i) => (
                            <div key={e.id} className="relative pr-6 group">
                                <div className="absolute -right-[9px] top-1 w-4 h-4 rounded-full bg-violet-500 ring-4 ring-white"></div>
                                <div className="flex justify-between items-center">
                                    <span className="text-sm font-bold text-violet-500">{e.year}</span>
                                    <button onClick={()=>deleteDoc(doc(db,'timeline',e.id))} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity"><Trash2 size={14}/></button>
                                </div>
                                <h4 className="font-bold text-lg">{e.title}</h4>
                            </div>
                        ))}
                    </div>
                </div>
            )
        }

        function HouseApp({ user }) {
            const [tab, setTab] = useState('rules');
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex gap-2 mb-6">
                        <button onClick={() => setTab('rules')} className={`flex-1 py-2 rounded-xl font-bold ${tab === 'rules' ? 'bg-slate-600 text-white' : 'bg-white'}`}>ğŸ“œ Ù‚ÙˆØ§Ù†ÛŒÙ†</button>
                        <button onClick={() => setTab('repair')} className={`flex-1 py-2 rounded-xl font-bold ${tab === 'repair' ? 'bg-slate-600 text-white' : 'bg-white'}`}>ğŸ”§ ØªØ¹Ù…ÛŒØ±Ø§Øª</button>
                        <button onClick={() => setTab('contacts')} className={`flex-1 py-2 rounded-xl font-bold ${tab === 'contacts' ? 'bg-slate-600 text-white' : 'bg-white'}`}>ğŸ“ ØªÙ„ÙÙ†â€ŒÙ‡Ø§</button>
                    </div>
                    {tab === 'rules' && <HouseRules />}
                    {tab === 'repair' && <RepairApp user={user} />}
                    {tab === 'contacts' && <ContactsApp user={user} />}
                </div>
            )
        }

        function HouseRules() {
            // New: Dynamic Rules
            const [rules, setRules] = useState([]);
            const [newRule, setNewRule] = useState('');
            useEffect(() => onSnapshot(query(collection(db, 'rules'), orderBy('createdAt', 'desc')), s => setRules(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            
            const add = async (e) => {
                e.preventDefault();
                if(!newRule) return;
                await addDoc(collection(db, 'rules'), { text: newRule, createdAt: serverTimestamp() });
                setNewRule('');
            };

            return (
                <div className="space-y-4">
                    <form onSubmit={add} className="flex gap-2 bg-white p-3 rounded-xl border">
                        <input value={newRule} onChange={e=>setNewRule(e.target.value)} placeholder="Ù‚Ø§Ù†ÙˆÙ† Ø¬Ø¯ÛŒØ¯ (Ù…Ø«Ù„Ø§: Ø³Ø§Ø¹Øª Û±Û± Ø®Ø§Ù…ÙˆØ´ÛŒ)" className="flex-1 p-2 border rounded-lg"/>
                        <button className="bg-slate-600 text-white px-4 rounded-lg font-bold">+</button>
                    </form>
                    <div className="bg-white p-6 rounded-2xl border text-center space-y-4">
                        <h3 className="text-2xl font-black mb-4">Ù‚ÙˆØ§Ù†ÛŒÙ† Ø®Ø§Ù†Ù‡ Ù…Ø§ ğŸ </h3>
                        <ul className="space-y-3">
                            {rules.map(r => (
                                <li key={r.id} className="flex justify-between items-center bg-slate-50 p-2 rounded-lg text-right">
                                    <div className="flex items-center gap-2">
                                        <div className="w-2 h-2 rounded-full bg-slate-400"></div>
                                        <span>{r.text}</span>
                                    </div>
                                    <button onClick={()=>deleteDoc(doc(db,'rules',r.id))} className="text-slate-300 hover:text-red-500"><Trash2 size={14}/></button>
                                </li>
                            ))}
                        </ul>
                    </div>
                </div>
            )
        }

        function ContactsApp({ user }) {
             // Updated: Dynamic Contacts
             const [contacts, setContacts] = useState([]);
             const [name, setName] = useState('');
             const [phone, setPhone] = useState('');

             useEffect(() => onSnapshot(query(collection(db, 'contacts'), orderBy('createdAt', 'desc')), s => setContacts(s.docs.map(d => ({id: d.id, ...d.data()})))), []);

             const add = async (e) => {
                 e.preventDefault();
                 if(!name || !phone) return;
                 await addDoc(collection(db, 'contacts'), { name, phone, createdAt: serverTimestamp() });
                 setName(''); setPhone('');
             };

             return (
                 <div className="space-y-4">
                     <form onSubmit={add} className="flex gap-2 bg-white p-3 rounded-xl border">
                         <input value={name} onChange={e=>setName(e.target.value)} placeholder="Ù†Ø§Ù… (Ù…Ø«Ù„Ø§ Ø¯Ú©ØªØ±)" className="flex-1 p-2 border rounded-lg"/>
                         <input value={phone} onChange={e=>setPhone(e.target.value)} placeholder="Ø´Ù…Ø§Ø±Ù‡" className="w-1/3 p-2 border rounded-lg" dir="ltr"/>
                         <button className="bg-green-600 text-white px-4 rounded-lg font-bold">+</button>
                     </form>
                     <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         {contacts.map((c) => (
                             <div key={c.id} className="bg-white p-4 rounded-xl border font-bold flex justify-between items-center gap-3">
                                 <div className="flex items-center gap-3">
                                     <Phone className="text-green-500" size={20}/>
                                     <div>
                                        <div className="text-sm text-slate-500">{c.name}</div>
                                        <div className="text-lg" dir="ltr">{c.phone}</div>
                                     </div>
                                 </div>
                                 <button onClick={()=>deleteDoc(doc(db,'contacts',c.id))} className="text-slate-300 hover:text-red-500"><Trash2 size={16}/></button>
                             </div>
                         ))}
                     </div>
                 </div>
             )
        }
        
        // --- Existing/Helper Apps Simplified for Single File ---
        // I've kept the logic for Calendar, Shopping, Finance, Health, Chat, Journal mostly standard
        
        function CalendarApp({ user }) {
            const [events, setEvents] = useState([]);
            const [newTitle, setNewTitle] = useState('');
            const [newTime, setNewTime] = useState('');
            // Countdown logic
            const [targetDate, setTargetDate] = useState('1403/01/01'); 
            
            useEffect(() => onSnapshot(query(collection(db, 'events'), orderBy('createdAt', 'desc')), s => setEvents(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!newTitle)return; await addDoc(collection(db, 'events'), { title: newTitle, time: newTime || 'ØªÙ…Ø§Ù… Ø±ÙˆØ²', createdBy: user.name, createdAt: serverTimestamp() }); setNewTitle(''); }
            
            return (
                <div className="space-y-6">
                    <div className="bg-purple-600 text-white p-6 rounded-2xl text-center shadow-lg">
                        <h3 className="text-lg opacity-80 mb-2">Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ú©ÙˆØ³ ØªØ§ Ø¹ÛŒØ¯ Ù†ÙˆØ±ÙˆØ² ğŸ‰</h3>
                        <div className="text-4xl font-black" dir="ltr">120 <span className="text-sm font-normal">Ø±ÙˆØ²</span></div>
                    </div>
                    <form onSubmit={add} className="bg-white p-4 rounded-xl border flex gap-2"><input value={newTitle} onChange={e=>setNewTitle(e.target.value)} placeholder="Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯" className="flex-1 p-2 border rounded-lg"/><button className="bg-purple-600 text-white px-4 rounded-lg">+</button></form>
                    <div className="space-y-2">{events.map(e => <div key={e.id} className="bg-white p-3 rounded-xl border flex justify-between"><span>{e.title} <span className="text-xs text-slate-400">({e.time})</span></span><button onClick={()=>deleteDoc(doc(db,'events',e.id))}><Trash2 size={16} className="text-slate-300"/></button></div>)}</div>
                </div>
            )
        }

        function ShoppingApp({ user }) {
             const [items, setItems] = useState([]);
             const [newItem, setNewItem] = useState('');
             useEffect(() => onSnapshot(query(collection(db, 'shopping'), orderBy('createdAt', 'desc')), s => setItems(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
             const add = async (e) => { e.preventDefault(); if(!newItem)return; await addDoc(collection(db, 'shopping'), { name: newItem, isBought: false }); setNewItem(''); }
             return (
                 <div className="space-y-4">
                     <form onSubmit={add} className="bg-white p-2 border rounded-xl flex gap-2"><input value={newItem} onChange={e=>setNewItem(e.target.value)} placeholder="Ú†ÛŒ Ø¨Ø®Ø±ÛŒÙ…ØŸ" className="flex-1 p-2 outline-none"/><button className="bg-pink-500 text-white px-4 rounded-lg font-bold">Add</button></form>
                     <div className="space-y-2">{items.map(i => <div key={i.id} onClick={()=>updateDoc(doc(db,'shopping',i.id),{isBought:!i.isBought})} className={`bg-white p-3 rounded-xl border flex justify-between cursor-pointer ${i.isBought?'opacity-50 line-through':''}`}><span>{i.name}</span><CheckSquare size={16} className={i.isBought?'text-pink-500':'text-slate-300'}/></div>)}</div>
                 </div>
             )
        }

        function FinanceApp({ user }) {
             const [items, setItems] = useState([]);
             const [amount, setAmount] = useState('');
             const [desc, setDesc] = useState('');
             const [type, setType] = useState('expense');
             useEffect(() => onSnapshot(query(collection(db, 'finance'), orderBy('createdAt', 'desc')), s => setItems(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
             const add = async (e) => { e.preventDefault(); if(!amount)return; await addDoc(collection(db, 'finance'), { amount: parseInt(amount), description: desc, type, createdAt: serverTimestamp() }); setAmount(''); setDesc(''); }
             return (
                 <div className="space-y-4">
                     <form onSubmit={add} className="bg-white p-4 rounded-xl border space-y-2">
                         <div className="flex gap-2"><button type="button" onClick={()=>setType('expense')} className={`flex-1 py-1 rounded ${type==='expense'?'bg-rose-100 text-rose-600':'bg-slate-50'}`}>Ù‡Ø²ÛŒÙ†Ù‡</button><button type="button" onClick={()=>setType('income')} className={`flex-1 py-1 rounded ${type==='income'?'bg-emerald-100 text-emerald-600':'bg-slate-50'}`}>Ø¯Ø±Ø¢Ù…Ø¯</button></div>
                         <input type="number" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="Ù…Ø¨Ù„Øº" className="w-full p-2 border rounded-lg"/>
                         <input value={desc} onChange={e=>setDesc(e.target.value)} placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª" className="w-full p-2 border rounded-lg"/>
                         <button className="bg-emerald-600 text-white w-full py-2 rounded-lg">Ø«Ø¨Øª</button>
                     </form>
                     <div className="space-y-2">{items.map(i => <div key={i.id} className="bg-white p-3 rounded-xl border flex justify-between"><span>{i.description}</span><span className={i.type==='expense'?'text-rose-600':'text-emerald-600'}>{i.amount.toLocaleString()}</span></div>)}</div>
                 </div>
             )
        }

        function RepairApp({ user }) {
             const [items, setItems] = useState([]);
             const [txt, setTxt] = useState('');
             useEffect(() => onSnapshot(collection(db, 'repair'), s => setItems(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
             const add = async (e) => { e.preventDefault(); if(!txt)return; await addDoc(collection(db, 'repair'), { text: txt, status: 'pending' }); setTxt(''); }
             return (
                 <div className="space-y-4">
                     <form onSubmit={add} className="flex gap-2"><input value={txt} onChange={e=>setTxt(e.target.value)} placeholder="Ø®Ø±Ø§Ø¨ÛŒ Ø¬Ø¯ÛŒØ¯..." className="flex-1 p-2 border rounded-lg"/><button className="bg-slate-600 text-white px-4 rounded-lg">+</button></form>
                     <div className="space-y-2">{items.map(i => <div key={i.id} className="bg-white p-3 rounded-xl border flex justify-between"><span>{i.text}</span><button onClick={()=>deleteDoc(doc(db,'repair',i.id))}><Trash2 size={14} className="text-slate-300"/></button></div>)}</div>
                 </div>
             )
        }

        function HealthApp({ user }) {
            const [meds, setMeds] = useState([]);
            const [newMed, setNewMed] = useState('');
            useEffect(() => onSnapshot(collection(db, 'medications'), s => setMeds(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!newMed)return; await addDoc(collection(db, 'medications'), { name: newMed }); setNewMed(''); }
            return (
                 <div className="space-y-4">
                     <form onSubmit={add} className="flex gap-2"><input value={newMed} onChange={e=>setNewMed(e.target.value)} placeholder="Ø¯Ø§Ø±ÙˆÛŒ Ø¬Ø¯ÛŒØ¯" className="flex-1 p-2 border rounded-lg"/><button className="bg-red-500 text-white px-4 rounded-lg">+</button></form>
                     <div className="space-y-2">{meds.map(i => <div key={i.id} className="bg-white p-3 rounded-xl border flex justify-between"><span>{i.name}</span><button onClick={()=>deleteDoc(doc(db,'medications',i.id))}><Trash2 size={14} className="text-slate-300"/></button></div>)}</div>
                 </div>
            )
        }

        function JournalApp({ user }) {
            const [notes, setNotes] = useState([]);
            const [text, setText] = useState('');
            useEffect(() => onSnapshot(query(collection(db, 'journal'), orderBy('createdAt', 'desc')), s => setNotes(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!text)return; await addDoc(collection(db, 'journal'), { text, by: user.name, createdAt: serverTimestamp() }); setText(''); }
            return (
                <div className="space-y-4">
                    <form onSubmit={add} className="bg-amber-50 p-4 rounded-xl border border-amber-200"><textarea value={text} onChange={e=>setText(e.target.value)} placeholder="Ø§Ù…Ø±ÙˆØ² Ú†Ù‡ Ø§ØªÙØ§Ù‚ÛŒ Ø§ÙØªØ§Ø¯ØŸ" className="w-full p-2 bg-white rounded-lg h-24"/><button className="mt-2 bg-amber-600 text-white w-full py-2 rounded-lg font-bold">Ø«Ø¨Øª Ø®Ø§Ø·Ø±Ù‡</button></form>
                    <div className="space-y-3">{notes.map(n => <div key={n.id} className="bg-white p-4 rounded-xl border shadow-sm relative"><p className="text-slate-700">{n.text}</p><p className="text-xs text-slate-400 mt-2 text-left">{n.by}</p><button onClick={()=>deleteDoc(doc(db,'journal',n.id))} className="absolute top-2 left-2 text-slate-300 hover:text-red-500"><Trash2 size={14}/></button></div>)}</div>
                </div>
            )
        }

        function ChatApp({ user }) {
            const [msgs, setMsgs] = useState([]);
            const [txt, setTxt] = useState('');
            useEffect(() => onSnapshot(query(collection(db, 'messages'), orderBy('createdAt', 'asc')), s => setMsgs(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const send = async (e) => { e.preventDefault(); if(!txt)return; await addDoc(collection(db, 'messages'), { text: txt, sender: user.name, senderId: user.id, createdAt: serverTimestamp() }); setTxt(''); }
            return (
                <div className="flex flex-col h-[70vh] bg-white rounded-2xl border overflow-hidden">
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">{msgs.map(m => <div key={m.id} className={`flex flex-col ${m.senderId===user.id?'items-end':'items-start'}`}><div className={`px-4 py-2 rounded-2xl max-w-[85%] text-sm ${m.senderId===user.id?'bg-teal-600 text-white rounded-br-none':'bg-white border rounded-bl-none'}`}>{m.text}</div><span className="text-[10px] text-slate-400 px-1">{m.sender}</span></div>)}</div>
                    <form onSubmit={send} className="p-2 border-t flex gap-2"><input value={txt} onChange={e=>setTxt(e.target.value)} className="flex-1 px-4 py-2 bg-slate-100 rounded-xl outline-none" placeholder="..." /><button className="bg-teal-600 text-white p-2 rounded-xl"><ArrowUpCircle/></button></form>
                </div>
            )
        }

        // Render
        const root = createRoot(document.getElementById('root'));
        root.render(<FamilyOS />);
    </script>
</body>
</html>
