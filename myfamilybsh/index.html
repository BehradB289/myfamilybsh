<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family OS Pro v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        body { font-family: 'Vazirmatn', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .glass-panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
        .dark .glass-panel { background: rgba(30, 41, 59, 0.7); }
    </style>
    <!-- Import Map for React and Firebase modules -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1",
                "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 overflow-hidden selection:bg-indigo-200 selection:text-indigo-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, 
            query, orderBy, onSnapshot, serverTimestamp, setDoc, getDoc, where, arrayUnion 
        } from 'firebase/firestore';
        import { 
            Home, Calendar, CheckSquare, ShoppingCart, DollarSign, 
            MessageCircle, Wifi, Book, Utensils, Wrench, Repeat, Trash2, 
            ChevronRight, Smartphone, Sun, Moon, HeartPulse, Loader2,
            Clock, CheckCircle2, ArrowUpCircle, Coffee, UtensilsCrossed, Pill,
            TrendingUp, TrendingDown, PieChart, Gavel, Vote, Gift, 
            Image as ImageIcon, Music, Film, BookOpen, ScrollText, Phone, 
            ChefHat, Cookie, Smile, Frown, Gamepad2, Timer, Star, MapPin,
            User, UserCheck, Users, AlertTriangle, Megaphone, Lightbulb, Bell, XCircle, Heart
        } from 'lucide-react';

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhEB7Kax9LZi_16JcZ7dWyYsUIR6v-y0Y",
            authDomain: "family-app-9da43.firebaseapp.com",
            projectId: "family-app-9da43",
            storageBucket: "family-app-9da43.firebasestorage.app",
            messagingSenderId: "48481240206",
            appId: "1:48481240206:web:cb59f13e5ac7e0ff3b75df",
            measurementId: "G-QPM2GB57Y6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Constants & Data ---
        const FAMILY_MEMBERS = [
            { id: 'dad', name: 'Ø¨Ù‡Ø²Ø§Ø¯ (Ù¾Ø¯Ø±)', shortName: 'Ø¨Ù‡Ø²Ø§Ø¯', avatar: 'ğŸ‘¨ğŸ»', color: 'bg-blue-600', ring: 'ring-blue-200' },
            { id: 'mom', name: 'Ø´Ù‡Ø±Ø²Ø§Ø¯ (Ù…Ø§Ø¯Ø±)', shortName: 'Ø´Ù‡Ø±Ø²Ø§Ø¯', avatar: 'ğŸ‘©ğŸ»', color: 'bg-pink-600', ring: 'ring-pink-200' },
            { id: 'behrad', name: 'Ø¨Ù‡Ø±Ø§Ø¯ (Ù¾Ø³Ø± Ø§Ø±Ø´Ø¯)', shortName: 'Ø¨Ù‡Ø±Ø§Ø¯', avatar: 'ğŸ§‘ğŸ»', color: 'bg-indigo-600', ring: 'ring-indigo-200' },
            { id: 'shahrad', name: 'Ø´Ù‡Ø±Ø§Ø¯', shortName: 'Ø´Ù‡Ø±Ø§Ø¯', avatar: 'ğŸ‘¶ğŸ»', color: 'bg-green-500', ring: 'ring-green-200' },
        ];

        const APPS = [
            { id: 'calendar', name: 'ØªÙ‚ÙˆÛŒÙ… Ùˆ Ù…Ù†Ø§Ø³Ø¨Øª', icon: <Calendar />, color: 'bg-purple-500' },
            { id: 'tasks', name: 'Ú©Ø§Ø±Ù‡Ø§ Ùˆ Ø¬Ø§ÛŒØ²Ù‡', icon: <CheckSquare />, color: 'bg-blue-500' },
            { id: 'kitchen', name: 'Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡', icon: <ChefHat />, color: 'bg-orange-500' },
            { id: 'shopping', name: 'Ù„ÛŒØ³Øª Ø®Ø±ÛŒØ¯', icon: <ShoppingCart />, color: 'bg-pink-500' },
            { id: 'finance', name: 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø®Ø§Ø±Ø¬', icon: <DollarSign />, color: 'bg-emerald-500' },
            { id: 'democracy', name: 'Ø´ÙˆØ±Ø§ Ùˆ Ø¯Ø§Ø¯Ú¯Ø§Ù‡', icon: <Gavel />, color: 'bg-cyan-600' },
            { id: 'entertainment', name: 'Ø³Ø±Ú¯Ø±Ù…ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒ', icon: <Gamepad2 />, color: 'bg-violet-500' },
            { id: 'house', name: 'Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø§Ù†Ù‡', icon: <Home />, color: 'bg-slate-600' },
            { id: 'health', name: 'Ø¯Ø§Ø±Ùˆ Ùˆ Ø³Ù„Ø§Ù…Øª', icon: <HeartPulse />, color: 'bg-red-500' },
            { id: 'feedback', name: 'Ø³Ø®Ù†â€ŒÚ¯Ø§Ù‡ Ø¢Ø²Ø§Ø¯', icon: <Heart />, color: 'bg-rose-500' }, // Updated Name & Icon
            { id: 'chat', name: 'Ú†Øª Ø±ÙˆÙ…', icon: <MessageCircle />, color: 'bg-teal-500' },
        ];

        // --- Helpers ---
        const getDaysUntilDate = (dateString) => {
            if (!dateString) return null;
            const targetDate = new Date(dateString);
            const now = new Date();
            const diffTime = targetDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return diffDays;
        };

        const getPersianDate = (date) => {
           return new Date(date).toLocaleDateString('fa-IR');
        }


        // --- Main Component ---
        function FamilyOS() {
            const [currentUser, setCurrentUser] = useState(null);
            const [activeApp, setActiveApp] = useState(null);
            const [theme, setTheme] = useState('light');
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userPoints, setUserPoints] = useState(0);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        setIsAuthReady(true);
                    } else {
                        await signInAnonymously(auth);
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (currentUser) {
                    const unsub = onSnapshot(doc(db, 'users', currentUser.id), (doc) => {
                        if (doc.exists()) {
                            setUserPoints(doc.data().points || 0);
                        } else {
                            setDoc(doc.ref, { points: 0, name: currentUser.name });
                        }
                    });
                    return () => unsub();
                }
            }, [currentUser]);

            const switchUser = () => {
                setCurrentUser(null);
                setActiveApp(null);
            };

            if (!isAuthReady) return <LoadingScreen />;
            if (!currentUser) return <UserSelectScreen onSelect={setCurrentUser} />;

            return (
                <div className={`h-screen w-full overflow-hidden flex flex-col font-[vazirmatn,sans-serif] transition-colors duration-500 ${theme === 'dark' ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-900'}`} dir="rtl">
                    <Header 
                        user={currentUser} 
                        points={userPoints}
                        theme={theme} 
                        setTheme={setTheme} 
                        switchUser={switchUser} 
                        goHome={() => setActiveApp(null)} 
                    />
                    <NotificationBanner user={currentUser} openApp={setActiveApp} />
                    <main className="flex-1 overflow-hidden relative">
                        {activeApp ? (
                            <AppWindow app={activeApp} close={() => setActiveApp(null)} user={currentUser} theme={theme} userPoints={userPoints} />
                        ) : (
                            <Dashboard openApp={setActiveApp} user={currentUser} theme={theme} points={userPoints} />
                        )}
                    </main>
                </div>
            );
        }

        // --- Core UI Components ---

        function LoadingScreen() {
            return (
                <div className="h-screen w-full flex flex-col items-center justify-center bg-slate-50 text-slate-500 gap-4">
                    <Loader2 className="animate-spin text-indigo-600" size={48} />
                    <p className="font-bold text-black">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÛŒØ³ØªÙ…...</p>
                </div>
            );
        }

        function UserSelectScreen({ onSelect }) {
            return (
                <div className="h-screen bg-slate-50 flex flex-col items-center justify-center p-6 relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-indigo-100 via-slate-50 to-slate-50 opacity-50 z-0"></div>
                    <div className="text-center w-full max-w-3xl z-10">
                        <h1 className="text-4xl font-black text-slate-900 mb-2 tracking-tight">Family OS Pro</h1>
                        <p className="text-slate-600 mb-12 text-lg font-bold">Ù„Ø·ÙØ§Ù‹ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                            {FAMILY_MEMBERS.map((member) => (
                                <button key={member.id} onClick={() => onSelect(member)} className="bg-white/80 backdrop-blur-sm p-6 py-10 rounded-[2rem] border border-white shadow-xl hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 flex flex-col items-center gap-5 group">
                                    <div className={`w-24 h-24 rounded-full ${member.color} flex items-center justify-center text-5xl shadow-lg ring-4 ring-offset-4 ${member.ring} group-hover:scale-110 transition-transform duration-300`}>
                                        {member.avatar}
                                    </div>
                                    <span className="font-black text-lg text-black group-hover:text-indigo-600">{member.name.split(' ')[0]}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function Header({ user, points, theme, setTheme, switchUser, goHome }) {
            return (
                <header className={`px-6 py-4 flex justify-between items-center z-20 ${theme === 'dark' ? 'bg-slate-800/80 border-slate-700' : 'bg-white/80 border-slate-200/60'} backdrop-blur-xl sticky top-0 border-b transition-colors duration-300`}>
                    <div className="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity" onClick={goHome}>
                        <div className="w-11 h-11 bg-gradient-to-tr from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                            <Home size={22} />
                        </div>
                        <div>
                            <h1 className="font-black text-xl leading-tight tracking-tight text-black dark:text-white">Family OS</h1>
                            <p className="text-xs opacity-60 font-bold text-slate-700 dark:text-slate-300">Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ {user.shortName}</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-3">
                        <div className="hidden md:flex items-center gap-2 bg-amber-100 text-amber-900 px-4 py-1.5 rounded-full text-sm font-black border border-amber-200 shadow-sm">
                            <Star size={16} fill="currentColor" />
                            <span>{points.toLocaleString()} Ø³Ú©Ù‡</span>
                        </div>
                        <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className="p-2.5 rounded-full hover:bg-slate-200/50 transition-colors">
                            {theme === 'dark' ? <Sun size={20} /> : <Moon size={20} />}
                        </button>
                        <button onClick={switchUser} className="flex items-center gap-2 bg-slate-200/50 hover:bg-rose-100 text-slate-800 hover:text-rose-600 px-4 py-2 rounded-full transition-all text-sm font-bold">
                            <Repeat size={16} />
                            <span className="hidden md:inline">Ø®Ø±ÙˆØ¬</span>
                        </button>
                        <div className={`w-11 h-11 rounded-full ${user.color} p-0.5 border-2 border-white shadow-md flex items-center justify-center text-xl overflow-hidden`}>
                            {user.avatar}
                        </div>
                    </div>
                </header>
            );
        }

        function NotificationBanner({ user, openApp }) {
            const [notifs, setNotifs] = useState([]);

            useEffect(() => {
                if(!user) return;
                const qTasks = query(collection(db, 'tasks'), where('assignee', '==', user.name), where('isDone', '==', false));
                const unsubTasks = onSnapshot(qTasks, (s) => {
                    const tasks = s.docs.map(d => ({id: d.id, type: 'task', msg: `ÙˆØ¸ÛŒÙÙ‡ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡: ${d.data().title}`, app: 'tasks'}));
                    setNotifs(tasks); 
                });
                
                return () => unsubTasks();
            }, [user]);

            if (notifs.length === 0) return null;

            return (
                <div className="bg-red-500 text-white text-sm font-bold px-4 py-2 flex items-center justify-between animate-slide-up">
                    <div className="flex items-center gap-2">
                        <Bell size={16} className="animate-pulse"/>
                        <span>ØªÙˆØ¬Ù‡: {notifs.length} Ù…ÙˆØ±Ø¯ Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯! ({notifs[0].msg})</span>
                    </div>
                    <button onClick={() => openApp(notifs[0].app)} className="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-xs transition-colors">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button>
                </div>
            )
        }

        function Dashboard({ openApp, user, theme, points }) {
            const [financeSummary, setFinanceSummary] = useState({ income: 0, expense: 0 });

            useEffect(() => {
                const unsub = onSnapshot(collection(db, 'finance'), (snap) => {
                    let inc = 0, exp = 0;
                    snap.docs.forEach(doc => {
                        const d = doc.data();
                        if (d.type === 'income') inc += d.amount;
                        else exp += d.amount;
                    });
                    setFinanceSummary({ income: inc, expense: exp });
                });
                return () => unsub();
            }, []);

            const total = Math.max(financeSummary.income + financeSummary.expense, 1);

            return (
                <div className="h-full overflow-y-auto p-4 md:p-8 space-y-8 animate-fade-in pb-32">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {/* Welcome Card */}
                        <div className={`md:col-span-2 p-8 rounded-[2rem] ${theme === 'dark' ? 'bg-gradient-to-br from-indigo-900/50 to-slate-900 border-indigo-500/30' : 'bg-white border-indigo-50'} border shadow-xl shadow-indigo-500/5 relative overflow-hidden flex flex-col justify-between group`}>
                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                            <div>
                                <h2 className="text-4xl font-black mb-2 flex items-center gap-2 text-black dark:text-white">Ø³Ù„Ø§Ù… {user.shortName} <span className="animate-pulse">ğŸ‘‹</span></h2>
                                <p className="opacity-70 text-base mb-6 font-bold text-slate-600 dark:text-slate-300">Ø¨Ù‡ Ø®ÙˆÙ†Ù‡ Ù…Ø¬Ø§Ø²ÛŒ Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ! Ø§Ù…Ø±ÙˆØ² Ú†Ù‡ Ø®Ø¨Ø±Ù‡ØŸ</p>
                                <div className="bg-slate-100/80 p-4 rounded-2xl mb-6 backdrop-blur-sm border border-slate-200">
                                    <div className="flex justify-between text-xs mb-2 font-black opacity-90">
                                        <span className="text-emerald-700 flex items-center gap-1"><ArrowUpCircle size={14}/> Ø¯Ø±Ø¢Ù…Ø¯: {financeSummary.income.toLocaleString()}</span>
                                        <span className="text-rose-700 flex items-center gap-1"><TrendingDown size={14}/> Ù‡Ø²ÛŒÙ†Ù‡: {financeSummary.expense.toLocaleString()}</span>
                                    </div>
                                    <div className="w-full h-4 bg-slate-200/80 rounded-full overflow-hidden flex shadow-inner">
                                        <div style={{ width: `${(financeSummary.income / total) * 100}%` }} className="h-full bg-emerald-500 transition-all duration-1000"></div>
                                        <div style={{ width: `${(financeSummary.expense / total) * 100}%` }} className="h-full bg-rose-500 transition-all duration-1000"></div>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <button onClick={() => openApp('tasks')} className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-2xl text-sm font-bold shadow-lg shadow-indigo-200 flex-1 md:flex-none flex items-center justify-center gap-2 transition-all hover:-translate-y-1">
                                    <CheckSquare size={18}/> Ú©Ø§Ø±Ù‡Ø§ÛŒ Ù…Ù†
                                </button>
                                <button onClick={() => openApp('democracy')} className="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-3 rounded-2xl text-sm font-bold shadow-lg shadow-cyan-200 flex-1 md:flex-none flex items-center justify-center gap-2 transition-all hover:-translate-y-1">
                                    <Vote size={18}/> Ø±Ø£ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ
                                </button>
                            </div>
                        </div>

                        {/* Points Card */}
                        <div className={`p-8 rounded-[2rem] flex flex-col justify-between ${theme === 'dark' ? 'bg-slate-800' : 'bg-slate-800'} text-white shadow-xl relative overflow-hidden group`}>
                            <div className="absolute -right-10 -top-10 w-40 h-40 bg-white/5 rounded-full blur-3xl group-hover:bg-white/10 transition-colors"></div>
                            <div className="flex justify-between items-start z-10">
                                <span className="opacity-80 text-sm font-bold">Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø´Ù…Ø§</span>
                                <div className="bg-white/10 p-2 rounded-xl"><Star className="text-yellow-400" fill="currentColor" size={24} /></div>
                            </div>
                            <div className="z-10">
                                <p className="text-6xl font-black mt-4 tracking-tighter" dir="ltr">{points.toLocaleString()}</p>
                                <p className="text-sm opacity-70 mt-2 font-bold">Ø³Ú©Ù‡ Ù‚Ø§Ø¨Ù„ Ø®Ø±Ø¬ Ú©Ø±Ø¯Ù†</p>
                            </div>
                            <button onClick={()=>openApp('tasks')} className="mt-4 w-full py-2 bg-white/10 hover:bg-white/20 rounded-xl text-sm font-bold transition-colors z-10">ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¬ÙˆØ§ÛŒØ²</button>
                        </div>
                    </div>

                    {/* App Grid */}
                    <div>
                        <h3 className="font-black text-xl mb-6 opacity-90 flex items-center gap-2 text-black dark:text-white"><PieChart size={22} className="text-indigo-500" /> Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ</h3>
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-5">
                            {APPS.map(app => (
                                <button key={app.id} onClick={() => openApp(app.id)} className={`p-5 rounded-[1.5rem] flex flex-col items-center gap-4 transition-all duration-300 hover:scale-105 hover:shadow-xl group ${theme === 'dark' ? 'bg-slate-800 hover:bg-slate-700' : 'bg-white hover:bg-indigo-50/50'} border border-transparent hover:border-indigo-100 shadow-sm`}>
                                    <div className={`w-16 h-16 rounded-2xl ${app.color} text-white flex items-center justify-center shadow-lg shadow-${app.color.replace('bg-', '')}/30 group-hover:rotate-6 transition-transform duration-300`}>
                                        {React.cloneElement(app.icon, { size: 30 })}
                                    </div>
                                    <span className="font-bold text-sm text-center text-black dark:text-slate-100">{app.name}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function AppWindow({ app: appId, close, user, theme, userPoints }) {
            const appData = APPS.find(a => a.id === appId);
            return (
                <div className={`absolute inset-0 z-30 flex flex-col ${theme === 'dark' ? 'bg-slate-900' : 'bg-slate-50'} animate-slide-up`}>
                    <div className={`px-6 py-4 flex items-center justify-between ${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-white/90 border-slate-200'} border-b shadow-sm sticky top-0 z-20 backdrop-blur-md`}>
                        <div className="flex items-center gap-4">
                            <button onClick={close} className="p-2 hover:bg-slate-200/50 rounded-full transition-colors"><ChevronRight size={28} className="text-black dark:text-white"/></button>
                            <div className={`w-11 h-11 rounded-xl ${appData.color} flex items-center justify-center text-white shadow-md`}>{appData.icon}</div>
                            <h2 className="text-2xl font-black tracking-tight text-black dark:text-white">{appData.name}</h2>
                        </div>
                        <button onClick={close} className="text-sm font-bold opacity-70 hover:opacity-100 px-4 py-2 hover:bg-slate-200 rounded-lg transition-all text-black dark:text-white">Ø¨Ø³ØªÙ†</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
                        <div className="max-w-6xl mx-auto">
                            {appId === 'calendar' && <CalendarApp user={user} />}
                            {appId === 'tasks' && <TasksApp user={user} points={userPoints} />}
                            {appId === 'kitchen' && <KitchenApp user={user} />}
                            {appId === 'shopping' && <ShoppingApp user={user} />}
                            {appId === 'finance' && <FinanceApp user={user} />}
                            {appId === 'democracy' && <DemocracyApp user={user} />}
                            {appId === 'entertainment' && <EntertainmentApp user={user} />}
                            {appId === 'house' && <HouseApp user={user} />}
                            {appId === 'health' && <HealthApp user={user} />}
                            {appId === 'feedback' && <FeedbackApp user={user} />}
                            {appId === 'chat' && <ChatApp user={user} />}
                        </div>
                    </div>
                </div>
            );
        }

        // --- UPDATED APPS ---

        function DemocracyApp({ user }) {
            const [tab, setTab] = useState('poll');
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex gap-3 mb-8 overflow-x-auto pb-2 px-1">
                        <button onClick={() => setTab('poll')} className={`flex items-center gap-2 px-6 py-3 rounded-2xl font-black whitespace-nowrap transition-all border ${tab === 'poll' ? 'bg-cyan-600 text-white border-cyan-600 shadow-lg shadow-cyan-200' : 'bg-white text-black border-slate-200 hover:bg-cyan-50'}`}>
                            <Vote size={20}/> Ø±Ø£ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ
                        </button>
                        <button onClick={() => setTab('court')} className={`flex items-center gap-2 px-6 py-3 rounded-2xl font-black whitespace-nowrap transition-all border ${tab === 'court' ? 'bg-cyan-600 text-white border-cyan-600 shadow-lg shadow-cyan-200' : 'bg-white text-black border-slate-200 hover:bg-cyan-50'}`}>
                            <Gavel size={20}/> Ø¯Ø§Ø¯Ú¯Ø§Ù‡ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡
                        </button>
                        <button onClick={() => setTab('council')} className={`flex items-center gap-2 px-6 py-3 rounded-2xl font-black whitespace-nowrap transition-all border ${tab === 'council' ? 'bg-cyan-600 text-white border-cyan-600 shadow-lg shadow-cyan-200' : 'bg-white text-black border-slate-200 hover:bg-cyan-50'}`}>
                            <Users size={20}/> Ø´ÙˆØ±Ø§ÛŒ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡
                        </button>
                    </div>
                    {tab === 'poll' && <PollingSystem user={user} />}
                    {tab === 'court' && <FamilyCourt user={user} />}
                    {tab === 'council' && <CouncilChat user={user} />}
                </div>
            );
        }

        function CouncilChat({ user }) {
            const [msgs, setMsgs] = useState([]);
            const [txt, setTxt] = useState('');
            const [meetingTime, setMeetingTime] = useState('');
            const [nextMeeting, setNextMeeting] = useState('Ù‡Ù†ÙˆØ² ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡');

            useEffect(() => {
                const u1 = onSnapshot(query(collection(db, 'council_chat'), orderBy('createdAt', 'asc')), s => setMsgs(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const u2 = onSnapshot(doc(db, 'council_meta', 'info'), d => {
                    if (d.exists()) setNextMeeting(d.data().time || 'Ù‡Ù†ÙˆØ² ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡');
                });
                return () => { u1(); u2(); };
            }, []);

            const send = async (e) => { e.preventDefault(); if(!txt)return; await addDoc(collection(db, 'council_chat'), { text: txt, sender: user.name, senderId: user.id, createdAt: serverTimestamp() }); setTxt(''); }
            
            const updateTime = async (e) => {
                e.preventDefault();
                if(!meetingTime) return;
                await setDoc(doc(db, 'council_meta', 'info'), { time: meetingTime }, { merge: true });
                setMeetingTime('');
            }

            return (
                <div className="flex flex-col h-[70vh] bg-white rounded-3xl border shadow-sm overflow-hidden relative">
                    {/* Meeting Time Banner */}
                    <div className="bg-cyan-600 text-white p-4 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-3">
                            <Clock className="animate-pulse" size={24}/>
                            <div>
                                <p className="text-xs opacity-80 font-bold">Ø²Ù…Ø§Ù† Ø¯ÙˆØ±Ù‡Ù…ÛŒ/Ø¨Ø§Ø²ÛŒ Ø¨Ø¹Ø¯ÛŒ:</p>
                                <p className="text-xl font-black">{nextMeeting}</p>
                            </div>
                        </div>
                        <form onSubmit={updateTime} className="flex gap-2 w-full md:w-auto">
                            <input value={meetingTime} onChange={e=>setMeetingTime(e.target.value)} placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¬Ù…Ø¹Ù‡ Ø³Ø§Ø¹Øª Û²Û°" className="flex-1 md:w-48 p-2 rounded-xl text-black text-sm font-bold outline-none"/>
                            <button className="bg-cyan-800 hover:bg-cyan-900 px-4 py-2 rounded-xl text-sm font-bold transition-colors">ØªÙ†Ø¸ÛŒÙ…</button>
                        </form>
                    </div>

                    <div className="bg-cyan-50 p-2 border-b border-cyan-100 flex items-center justify-center gap-2 text-cyan-800 font-bold text-xs">
                        <span>Û± Ø³Ø§Ø¹Øª Ø¨Ø¯ÙˆÙ† Ú¯ÙˆØ´ÛŒ Ùˆ ØªÙ„ÙˆÛŒØ²ÛŒÙˆÙ†ØŒ ÙÙ‚Ø· Ø­Ø±Ù Ùˆ Ø¨Ø§Ø²ÛŒ!</span>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                        {msgs.map(m => (
                            <div key={m.id} className={`flex flex-col ${m.senderId===user.id?'items-end':'items-start'}`}>
                                <div className={`px-4 py-3 rounded-2xl max-w-[85%] text-sm font-bold shadow-sm ${m.senderId===user.id?'bg-cyan-600 text-white rounded-br-none':'bg-white border rounded-bl-none text-black'}`}>{m.text}</div>
                                <span className="text-[10px] text-slate-500 px-1 font-bold mt-1">{m.sender}</span>
                            </div>
                        ))}
                    </div>
                    <form onSubmit={send} className="p-3 border-t bg-white flex gap-2">
                        <input value={txt} onChange={e=>setTxt(e.target.value)} className="flex-1 px-4 py-3 bg-slate-100 rounded-2xl outline-none text-black font-bold focus:bg-white focus:ring-2 ring-cyan-200 transition-all" placeholder="ØµØ­Ø¨Øª Ø´Ù…Ø§..." />
                        <button className="bg-cyan-600 text-white p-3 rounded-2xl hover:bg-cyan-700 transition-colors shadow-lg shadow-cyan-200"><ArrowUpCircle/></button>
                    </form>
                </div>
            )
        }

        function PollingSystem({ user }) {
            const [polls, setPolls] = useState([]);
            const [newPoll, setNewPoll] = useState('');
            const [options, setOptions] = useState(['', '']);
            useEffect(() => onSnapshot(query(collection(db, 'polls'), orderBy('createdAt', 'desc')), s => setPolls(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const createPoll = async (e) => {
                e.preventDefault(); if(!newPoll || options.some(o => !o)) return;
                await addDoc(collection(db, 'polls'), { question: newPoll, options: options.map(o => ({ text: o, votes: [] })), createdBy: user.name, createdAt: serverTimestamp() });
                setNewPoll(''); setOptions(['', '']);
            };
            const vote = async (poll, idx) => {
                const newOpts = [...poll.options];
                newOpts.forEach(o => o.votes = o.votes.filter(id => id !== user.id));
                newOpts[idx].votes.push(user.id);
                await updateDoc(doc(db, 'polls', poll.id), { options: newOpts });
            };
            return (
                <div className="space-y-6">
                    <form onSubmit={createPoll} className="bg-white p-6 rounded-3xl border shadow-sm space-y-4">
                        <h4 className="font-bold text-black border-b pb-2 mb-2">Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø¬Ø¯ÛŒØ¯</h4>
                        <input value={newPoll} onChange={e=>setNewPoll(e.target.value)} placeholder="Ø³ÙˆØ§Ù„ Ø±Ø£ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ (Ù…Ø«Ù„Ø§Ù‹: Ø´Ø§Ù… Ø¬Ù…Ø¹Ù‡ Ú†ÛŒ Ø¨Ø§Ø´Ù‡ØŸ)" className="w-full p-3 border rounded-xl outline-none focus:border-cyan-500 font-bold text-black" />
                        <div className="flex gap-2">
                            {options.map((opt, i) => <input key={i} value={opt} onChange={e=>{const n=[...options];n[i]=e.target.value;setOptions(n)}} placeholder={`Ú¯Ø²ÛŒÙ†Ù‡ ${i+1}`} className="flex-1 p-3 border rounded-xl outline-none focus:border-cyan-500 text-black font-bold" />)}
                        </div>
                        <button className="bg-cyan-600 text-white w-full py-3 rounded-xl font-black hover:bg-cyan-700 transition-colors">Ø§Ù†ØªØ´Ø§Ø± Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ</button>
                    </form>

                    <div className="grid gap-6">
                        {polls.map(p => (
                            <div key={p.id} className="bg-white p-6 rounded-3xl border shadow-sm relative overflow-hidden">
                                <div className="flex justify-between mb-6 relative z-10">
                                    <h4 className="font-black text-lg text-black">{p.question}</h4>
                                    <button onClick={()=>deleteDoc(doc(db,'polls',p.id))}><Trash2 size={18} className="text-slate-300 hover:text-red-500"/></button>
                                </div>
                                <div className="space-y-3 relative z-10">
                                    {p.options.map((o, i) => {
                                    const total = p.options.reduce((a,c)=>a+c.votes.length,0);
                                    const pct = total===0?0:Math.round((o.votes.length/total)*100);
                                    const isVoted = o.votes.includes(user.id);
                                    return (
                                        <div key={i} onClick={()=>vote(p,i)} className={`relative p-4 rounded-xl border-2 cursor-pointer overflow-hidden transition-all ${isVoted ? 'border-cyan-500 bg-cyan-50' : 'border-slate-100 hover:bg-slate-50'}`}>
                                            <div className="absolute inset-0 bg-cyan-100 transition-all duration-1000 origin-right opacity-30" style={{transform: `scaleX(${pct/100})`}}></div>
                                            <div className="relative flex justify-between z-10 items-center">
                                                <span className={`font-bold ${isVoted ? 'text-cyan-800' : 'text-slate-700'}`}>{o.text}</span>
                                                <span className="font-black text-black">{pct}% <span className="text-xs font-normal text-slate-500">({o.votes.length} Ø±Ø£ÛŒ)</span></span>
                                            </div>
                                        </div>
                                    )})}
                                </div>
                                <p className="text-xs text-slate-400 mt-4 relative z-10">Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø·: {p.createdBy}</p>
                            </div>
                        ))}
                    </div>
                </div>
            )
        }

        function FamilyCourt({ user }) {
            const [cases, setCases] = useState([]);
            const [form, setForm] = useState({ complaint: '', defendant: 'Ø¨Ù‡Ø²Ø§Ø¯ (Ù¾Ø¯Ø±)' });
            const [comment, setComment] = useState('');

            useEffect(() => onSnapshot(query(collection(db, 'court'), orderBy('createdAt', 'desc')), s => setCases(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            
            const file = async (e) => { e.preventDefault(); await addDoc(collection(db, 'court'), { plaintiff: user.name, ...form, verdict: 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ', votes: [], comments: [], createdAt: serverTimestamp() }); setForm({...form, complaint: ''}); }
            
            const addComment = async (id, currentComments) => {
                if(!comment) return;
                const newComment = { text: comment, author: user.name, time: new Date().toISOString() };
                await updateDoc(doc(db, 'court', id), { comments: arrayUnion(newComment) });
                setComment('');
            };

            const castVote = async (caseId, currentVotes, voteType) => {
                // Remove existing vote by this user if any
                const newVotes = (currentVotes || []).filter(v => v.user !== user.id);
                newVotes.push({ user: user.id, type: voteType });
                await updateDoc(doc(db, 'court', caseId), { votes: newVotes });
            };

            return (
                <div className="space-y-6">
                    <form onSubmit={file} className="bg-white p-6 rounded-3xl border shadow-sm space-y-4">
                        <h4 className="font-bold text-black border-b pb-2 mb-2">Ø«Ø¨Øª Ø´Ú©Ø§ÛŒØª Ø¬Ø¯ÛŒØ¯</h4>
                        <textarea value={form.complaint} onChange={e=>setForm({...form, complaint: e.target.value})} placeholder="Ø´Ø±Ø­ Ø´Ú©Ø§ÛŒØª (Ù…Ø«Ù„Ø§Ù‹: Ø´Ù‡Ø±Ø§Ø¯ Ø§Ø³Ø¨Ø§Ø¨â€ŒØ¨Ø§Ø²ÛŒ Ù…Ù† Ø±Ùˆ Ø®Ø±Ø§Ø¨ Ú©Ø±Ø¯...)" className="w-full p-4 border rounded-2xl h-32 outline-none focus:border-rose-500 text-black resize-none font-bold" />
                        <div className="flex gap-3 items-center flex-wrap">
                            <span className="font-bold text-slate-600">Ø´Ú©Ø§ÛŒØª Ø§Ø² Ø·Ø±Ù: <span className="text-black">{user.name}</span> Ø¹Ù„ÛŒÙ‡:</span>
                            <select value={form.defendant} onChange={e=>setForm({...form, defendant: e.target.value})} className="flex-1 p-3 border rounded-xl bg-white text-black font-bold outline-none focus:border-rose-500">
                                {FAMILY_MEMBERS.map(m=><option key={m.id} value={m.name}>{m.name}</option>)}
                            </select>
                            <button className="bg-rose-600 text-white px-8 py-3 rounded-xl font-black hover:bg-rose-700 transition-colors w-full sm:w-auto">Ø«Ø¨Øª Ù¾Ø±ÙˆÙ†Ø¯Ù‡</button>
                        </div>
                    </form>

                    <div className="space-y-4">
                        {cases.map(c => {
                            const guiltyVotes = (c.votes || []).filter(v => v.type === 'guilty').length;
                            const innocentVotes = (c.votes || []).filter(v => v.type === 'innocent').length;
                            return (
                                <div key={c.id} className="bg-white p-5 rounded-3xl border shadow-sm relative overflow-hidden">
                                    <div className="absolute top-0 right-0 w-2 h-full bg-rose-500"></div>
                                    <div className="mr-4 space-y-4">
                                        <div className="flex justify-between items-center">
                                            <div className="flex items-center gap-2">
                                                <span className="bg-rose-100 text-rose-800 px-3 py-1 rounded-lg text-xs font-bold">Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ù‚Ø¶Ø§ÛŒÛŒ</span>
                                                <button onClick={()=>deleteDoc(doc(db,'court',c.id))}><Trash2 size={16} className="text-slate-300 hover:text-red-500"/></button>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2 font-black text-lg text-black">
                                            <UserCheck size={20} className="text-green-600"/> <span className="text-green-700">{c.plaintiff}</span>
                                            <span className="text-slate-400 text-sm mx-1">Ø¹Ù„ÛŒÙ‡</span>
                                            <AlertTriangle size={20} className="text-rose-600"/> <span className="text-rose-700">{c.defendant}</span>
                                        </div>
                                        <p className="bg-slate-50 p-4 rounded-2xl text-slate-800 border border-slate-100 leading-relaxed font-bold">"{c.complaint}"</p>
                                        
                                        {/* Voting Section */}
                                        <div className="flex gap-4 items-center bg-slate-50 p-3 rounded-xl">
                                            <span className="font-bold text-sm">Ø±Ø£ÛŒ Ù‡ÛŒØ§Øª Ù…Ù†ØµÙÙ‡:</span>
                                            <button onClick={() => castVote(c.id, c.votes, 'guilty')} className="flex items-center gap-1 text-xs font-bold bg-rose-100 text-rose-700 px-3 py-1.5 rounded-lg hover:bg-rose-200">
                                                <Frown size={14}/> Ù…Ù‚ØµØ± ({guiltyVotes})
                                            </button>
                                            <button onClick={() => castVote(c.id, c.votes, 'innocent')} className="flex items-center gap-1 text-xs font-bold bg-green-100 text-green-700 px-3 py-1.5 rounded-lg hover:bg-green-200">
                                                <Smile size={14}/> Ø¨ÛŒâ€ŒÚ¯Ù†Ø§Ù‡ ({innocentVotes})
                                            </button>
                                        </div>

                                        {/* Comments */}
                                        <div className="space-y-2">
                                            <h5 className="font-bold text-sm text-slate-500">Ù†Ø¸Ø±Ø§Øª Ùˆ Ø¯ÙØ§Ø¹ÛŒØ§Øª:</h5>
                                            {(c.comments || []).map((cm, i) => (
                                                <div key={i} className="text-sm bg-slate-50 p-2 rounded-lg"><span className="font-bold text-indigo-600">{cm.author}:</span> {cm.text}</div>
                                            ))}
                                            <div className="flex gap-2">
                                                <input className="flex-1 border rounded-lg p-2 text-sm font-bold" placeholder="Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." onChange={e=>setComment(e.target.value)} />
                                                <button onClick={()=>addComment(c.id)} className="bg-indigo-500 text-white px-3 rounded-lg text-sm font-bold">Ø§Ø±Ø³Ø§Ù„</button>
                                            </div>
                                        </div>

                                        <div className="bg-amber-50 p-4 rounded-2xl border border-amber-100 mt-2">
                                            <div className="flex gap-2 items-center mb-1">
                                                <Gavel size={18} className="text-amber-600"/>
                                                <span className="font-black text-amber-800">Ø­Ú©Ù… Ù†Ù‡Ø§ÛŒÛŒ ÙˆØ§Ù„Ø¯ÛŒÙ†:</span>
                                            </div>
                                            {(user.id==='dad'||user.id==='mom') ? (
                                                <input className="w-full bg-white border-b-2 border-amber-200 outline-none p-2 rounded text-black font-bold focus:border-amber-500 transition-colors" defaultValue={c.verdict} onBlur={e=>updateDoc(doc(db,'court',c.id),{verdict:e.target.value})} placeholder="Ø­Ú©Ù… Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." />
                                            ) : (
                                                <p className="text-amber-900 font-bold p-2">{c.verdict}</p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )
        }

        function FeedbackApp({ user }) {
            const [notes, setNotes] = useState([]);
            const [text, setText] = useState('');
            useEffect(() => onSnapshot(query(collection(db, 'site_feedback'), orderBy('createdAt', 'desc')), s => setNotes(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!text)return; await addDoc(collection(db, 'site_feedback'), { text, author: user.name, createdAt: serverTimestamp() }); setText(''); }
            return (
                <div className="space-y-6 max-w-4xl mx-auto">
                    <div className="bg-rose-50 p-6 rounded-3xl border border-rose-100 flex items-center gap-4 mb-6">
                        <div className="bg-white p-3 rounded-full shadow-sm text-rose-600"><Heart size={32}/></div>
                        <div>
                            <h3 className="font-black text-xl text-rose-900">Ø³Ø®Ù†â€ŒÚ¯Ø§Ù‡ Ø¢Ø²Ø§Ø¯</h3>
                            <p className="text-rose-700 font-bold">Ù‡Ø± Ú©Ø³ Ù‡Ø± Ú†ÛŒ ØªÙˆ Ø¯Ù„Ø´ Ù‡Ø³Øª Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³Ù‡ (Ø­Ø±Ùâ€ŒÙ‡Ø§ÛŒ Ø¯Ù„ÛŒ)</p>
                        </div>
                    </div>

                    <form onSubmit={add} className="flex gap-3 items-stretch">
                        <input value={text} onChange={e=>setText(e.target.value)} placeholder="Ø­Ø±Ù Ø¯Ù„Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³..." className="flex-1 p-4 border rounded-2xl outline-none focus:border-rose-500 font-bold text-black" />
                        <button className="bg-rose-600 text-white px-6 rounded-2xl hover:bg-rose-700 transition-colors"><ArrowUpCircle size={28}/></button>
                    </form>

                    <div className="grid gap-4">
                        {notes.map(n => (
                            <div key={n.id} className="bg-white p-5 rounded-3xl border shadow-sm flex flex-col gap-2 relative">
                                <p className="text-black font-bold text-lg leading-relaxed">{n.text}</p>
                                <div className="flex justify-between items-center border-t pt-3 mt-1">
                                    <span className="text-xs font-bold text-rose-600 bg-rose-50 px-2 py-1 rounded-lg">{n.author}</span>
                                    <button onClick={()=>deleteDoc(doc(db,'site_feedback',n.id))}><Trash2 size={16} className="text-slate-300 hover:text-red-500"/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )
        }

        function ShoppingApp({ user }) {
             const [items, setItems] = useState([]);
             const [newItem, setNewItem] = useState('');
             const [targetList, setTargetList] = useState('shahrzad');
             const [shopper, setShopper] = useState('');
             
             useEffect(() => onSnapshot(query(collection(db, 'shopping'), orderBy('createdAt', 'desc')), s => setItems(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
             
             const add = async (e) => { 
                 e.preventDefault(); 
                 if(!newItem) return; 
                 await addDoc(collection(db, 'shopping'), { name: newItem, isBought: false, owner: targetList, shopper: shopper || 'Ù‡Ø±Ú©ÛŒ ØªÙˆÙ†Ø³Øª', addedBy: user.name, createdAt: serverTimestamp() }); 
                 setNewItem(''); 
             };

             const getLabel = (key) => {
                 if(key === 'behzad') return 'Ù„ÛŒØ³Øª Ø¨Ø§Ø¨Ø§ (Ø¨Ù‡Ø²Ø§Ø¯)';
                 if(key === 'shahrzad') return 'Ù„ÛŒØ³Øª Ù…Ø§Ù…Ø§Ù† (Ø´Ù‡Ø±Ø²Ø§Ø¯)';
                 if(key === 'behrad') return 'Ù„ÛŒØ³Øª Ø¨Ù‡Ø±Ø§Ø¯';
                 if(key === 'shahrad') return 'Ù„ÛŒØ³Øª Ø´Ù‡Ø±Ø§Ø¯ (Ú©ÙˆÚ†ÙˆÙ„Ùˆ)';
                 return 'Ù„ÛŒØ³Øª Ù†Ø§Ø´Ù†Ø§Ø³';
             };
             
             const lists = ['behzad', 'shahrzad', 'behrad', 'shahrad'];

             return (
                 <div className="space-y-8">
                     <form onSubmit={add} className="bg-white p-4 rounded-2xl border shadow-sm flex flex-col md:flex-row gap-4 items-end md:items-center">
                         <div className="flex-1 w-full space-y-2">
                             <label className="text-sm font-black text-black px-1">Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯</label>
                             <input value={newItem} onChange={e=>setNewItem(e.target.value)} placeholder="Ú†ÛŒ Ù„Ø§Ø²Ù… Ø¯Ø§Ø±ÛŒÙ…ØŸ" className="w-full p-3 border rounded-xl outline-none focus:border-pink-500 transition-colors text-black font-bold"/>
                         </div>
                         <div className="w-full md:w-40 space-y-2">
                            <label className="text-sm font-black text-black px-1">Ø¨Ø±Ø§ÛŒ Ú©ÛŒØŸ (ØµØ§Ø­Ø¨ Ù„ÛŒØ³Øª)</label>
                            <select value={targetList} onChange={e=>setTargetList(e.target.value)} className="w-full p-3 border rounded-xl bg-white outline-none text-black font-bold">
                                <option value="behzad">Ø¨Ø§Ø¨Ø§ Ø¨Ù‡Ø²Ø§Ø¯</option>
                                <option value="shahrzad">Ù…Ø§Ù…Ø§Ù† Ø´Ù‡Ø±Ø²Ø§Ø¯</option>
                                <option value="behrad">Ø¨Ù‡Ø±Ø§Ø¯</option>
                                <option value="shahrad">Ø´Ù‡Ø±Ø§Ø¯ (Ú©ÙˆÚ†ÙˆÙ„Ùˆ)</option>
                            </select>
                         </div>
                         <div className="w-full md:w-40 space-y-2">
                            <label className="text-sm font-black text-black px-1">Ú©ÛŒ Ø¨Ø®Ø±Ù‡ØŸ (Ù…Ø³Ø¦ÙˆÙ„)</label>
                            <select value={shopper} onChange={e=>setShopper(e.target.value)} className="w-full p-3 border rounded-xl bg-white outline-none text-black font-bold">
                                <option value="">Ù‡Ø±Ú©ÛŒ ØªÙˆÙ†Ø³Øª</option>
                                {/* Exclude Shahrad from shopper list */}
                                {FAMILY_MEMBERS.filter(m => m.id !== 'shahrad').map(m=><option key={m.id} value={m.name}>{m.shortName}</option>)}
                            </select>
                         </div>
                         <button className="w-full md:w-auto bg-pink-600 text-white px-8 py-3 rounded-xl font-black shadow-lg shadow-pink-200 hover:bg-pink-700 transition-colors">Ø§ÙØ²ÙˆØ¯Ù†</button>
                     </form>
                     
                     <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {lists.map(listKey => {
                            const listItems = items.filter(i => i.owner === listKey);
                            const colors = { behzad: 'blue', shahrzad: 'pink', behrad: 'indigo', shahrad: 'green' };
                            const color = colors[listKey];
                            return (
                                <div key={listKey} className={`bg-white rounded-3xl border border-slate-100 overflow-hidden flex flex-col shadow-lg shadow-${color}-100`}>
                                    <div className={`bg-${color}-50 p-4 border-b border-${color}-100 flex justify-between items-center`}>
                                        <h3 className={`font-black text-black text-sm`}>{getLabel(listKey)}</h3>
                                        <span className={`bg-${color}-200 text-${color}-900 px-2 py-0.5 rounded-lg text-xs font-black`}>{listItems.filter(i => !i.isBought).length} Ù…ÙˆØ±Ø¯</span>
                                    </div>
                                    <div className="p-2 space-y-1 flex-1">
                                        {listItems.length === 0 && <div className="text-center py-8 text-slate-400 text-xs font-bold">Ù„ÛŒØ³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</div>}
                                        {listItems.map(i => (
                                            <div key={i.id} onClick={()=>updateDoc(doc(db,'shopping',i.id),{isBought:!i.isBought})} className={`p-3 rounded-xl flex items-center justify-between cursor-pointer transition-all ${i.isBought ? 'bg-slate-50 opacity-50' : 'hover:bg-slate-50'}`}>
                                                <div className="flex flex-col gap-1 w-full">
                                                    <div className="flex items-center gap-2">
                                                        <div className={`w-4 h-4 rounded-md border-2 flex items-center justify-center transition-colors ${i.isBought ? `bg-${color}-500 border-${color}-500` : 'border-slate-300'}`}>
                                                            {i.isBought && <CheckSquare size={10} className="text-white"/>}
                                                        </div>
                                                        <span className={`font-bold text-sm ${i.isBought ? 'line-through text-slate-400' : 'text-black'}`}>{i.name}</span>
                                                    </div>
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-[10px] text-slate-500 font-bold bg-slate-100 px-1.5 py-0.5 rounded">Ø®Ø±ÛŒØ¯Ø§Ø±: {i.shopper}</span>
                                                        <button onClick={(e)=>{e.stopPropagation(); deleteDoc(doc(db,'shopping',i.id))}} className="text-slate-300 hover:text-red-500 p-1"><Trash2 size={12}/></button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                     </div>
                 </div>
             )
        }

        function TasksApp({ user, points }) {
            const [tab, setTab] = useState('tasks');
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex justify-between items-center mb-6">
                         <div className="flex gap-2">
                            <button onClick={() => setTab('tasks')} className={`px-4 py-2 rounded-xl font-black border transition-colors ${tab === 'tasks' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-black border-slate-200'}`}>ğŸ“ ÙˆØ¸Ø§ÛŒÙ</button>
                            <button onClick={() => setTab('shop')} className={`px-4 py-2 rounded-xl font-black border transition-colors ${tab === 'shop' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-black border-slate-200'}`}>ğŸ›ï¸ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</button>
                        </div>
                        <div className="bg-yellow-100 text-yellow-900 px-4 py-2 rounded-xl font-black flex items-center gap-2 border border-yellow-200">
                            <Star fill="currentColor" size={16}/> {points}
                        </div>
                    </div>
                    {tab === 'tasks' ? <TaskList user={user} /> : <RewardStore user={user} points={points} />}
                </div>
            );
        }

        function TaskList({ user }) {
            const [tasks, setTasks] = useState([]);
            const [newTask, setNewTask] = useState('');
            const [assignee, setAssignee] = useState(user.name);
            const [reward, setReward] = useState(10); // Changed to number
            useEffect(() => onSnapshot(query(collection(db, 'tasks'), orderBy('createdAt', 'desc')), s => setTasks(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const addTask = async (e) => { e.preventDefault(); if(!newTask) return; await addDoc(collection(db, 'tasks'), { title: newTask, assignee, reward: parseInt(reward), isDone: false, createdBy: user.name, createdAt: serverTimestamp() }); setNewTask(''); };
            const toggle = async (t) => {
                if (!t.isDone && user.name === t.assignee) {
                    const uDoc = await getDoc(doc(db, 'users', user.id));
                    await setDoc(doc(db, 'users', user.id), { points: (uDoc.data()?.points||0) + t.reward }, { merge: true });
                }
                await updateDoc(doc(db, 'tasks', t.id), { isDone: !t.isDone });
            };
            return (
                <div className="space-y-4">
                    <form onSubmit={addTask} className="bg-white p-4 rounded-xl border space-y-3">
                        <input value={newTask} onChange={e=>setNewTask(e.target.value)} placeholder="Ø¹Ù†ÙˆØ§Ù† ÙˆØ¸ÛŒÙÙ‡..." className="w-full p-2 border rounded-lg text-black font-bold" />
                        <div className="flex gap-2">
                            <select value={assignee} onChange={e=>setAssignee(e.target.value)} className="flex-1 p-2 border rounded-lg bg-white text-sm text-black font-bold">{FAMILY_MEMBERS.map(m=><option key={m.id} value={m.name}>{m.name}</option>)}</select>
                            <input type="number" value={reward} onChange={e=>setReward(e.target.value)} placeholder="Ø§Ù…ØªÛŒØ§Ø²" className="w-24 p-2 border rounded-lg bg-white text-sm text-black font-bold text-center" />
                            <button className="bg-blue-600 text-white px-4 rounded-lg font-bold">Ø§ÙØ²ÙˆØ¯Ù†</button>
                        </div>
                    </form>
                    <div className="space-y-2">{tasks.map(t => (
                        <div key={t.id} className={`flex justify-between items-center p-4 bg-white border rounded-xl ${t.isDone ? 'opacity-60 bg-slate-50' : ''}`}>
                            <div className="flex items-center gap-4">
                                <button onClick={()=>toggle(t)} disabled={t.isDone} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${t.isDone ? 'bg-green-500 border-green-500' : 'border-slate-300'}`}>{t.isDone && <CheckSquare size={14} className="text-white"/>}</button>
                                <div><p className={`font-bold text-black ${t.isDone ? 'line-through opacity-50' : ''}`}>{t.title}</p><div className="flex gap-2 text-xs text-slate-500 mt-1"><span className="bg-slate-100 px-2 rounded font-bold text-slate-700">{t.assignee}</span><span className="text-amber-600 font-bold">{t.reward} Ø³Ú©Ù‡</span></div></div>
                            </div>
                            <button onClick={()=>deleteDoc(doc(db,'tasks',t.id))}><Trash2 size={18} className="text-slate-300 hover:text-red-500"/></button>
                        </div>
                    ))}</div>
                </div>
            );
        }

        function RewardStore({ user, points }) {
            const [rewards, setRewards] = useState([]);
            const [newR, setNewR] = useState({ title: '', cost: 50, icon: 'ğŸ' });

            useEffect(() => onSnapshot(collection(db, 'rewards'), s => {
                const data = s.docs.map(d=>({id:d.id, ...d.data()}));
                if(data.length === 0) {
                    // Seed initial data if empty
                    const initial = [{t:'Ù…Ø¹Ø§ÙÛŒØª Ù†Ø¸Ø§ÙØª',c:60,i:'ğŸ§¹'},{t:'Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø§Ù…',c:40,i:'ğŸ•'},{t:'Ø¨Ø³ØªÙ†ÛŒ',c:20,i:'ğŸ¦'},{t:'Ø®ÙˆØ§Ø¨ Ø¨ÛŒØ´ØªØ±',c:30,i:'ğŸ˜´'}];
                    initial.forEach(r => addDoc(collection(db,'rewards'), { title: r.t, cost: r.c, icon: r.i }));
                } else {
                    setRewards(data);
                }
            }), []);

            const addReward = async (e) => { e.preventDefault(); if(!newR.title)return; await addDoc(collection(db, 'rewards'), newR); setNewR({title:'',cost:50,icon:'ğŸ'}); };
            const deleteReward = async (id) => { await deleteDoc(doc(db, 'rewards', id)); };
            
            const buy = async (cost) => { if(points>=cost){ await updateDoc(doc(db,'users',user.id),{points:points-cost}); alert('Ø®Ø±ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!'); } else alert('Ù¾ÙˆÙ„ Ù†Ø¯Ø§Ø±ÛŒ!'); };
            
            return (
                <div className="space-y-6">
                     <form onSubmit={addReward} className="bg-white p-4 rounded-xl border flex gap-2 items-center">
                        <input value={newR.title} onChange={e=>setNewR({...newR, title:e.target.value})} placeholder="Ø¬Ø§ÛŒØ²Ù‡ Ø¬Ø¯ÛŒØ¯..." className="flex-1 p-2 border rounded-lg text-black font-bold"/>
                        <input type="number" value={newR.cost} onChange={e=>setNewR({...newR, cost:parseInt(e.target.value)})} placeholder="Ù‚ÛŒÙ…Øª" className="w-20 p-2 border rounded-lg text-black font-bold"/>
                        <input value={newR.icon} onChange={e=>setNewR({...newR, icon:e.target.value})} placeholder="Ø¢ÛŒÚ©ÙˆÙ†" className="w-16 p-2 border rounded-lg text-center"/>
                        <button className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold">Ø«Ø¨Øª</button>
                    </form>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {rewards.map(r => (
                            <div key={r.id} className="bg-white p-4 rounded-2xl border shadow-sm flex flex-col items-center text-center gap-3 hover:-translate-y-1 transition-transform relative group">
                                <button onClick={()=>deleteReward(r.id)} className="absolute top-2 right-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={14}/></button>
                                <div className="text-4xl mb-2">{r.icon}</div>
                                <h4 className="font-black text-sm h-10 text-black">{r.title}</h4>
                                <button onClick={()=>buy(r.cost)} className={`w-full py-2 rounded-lg font-bold text-xs ${points>=r.cost?'bg-blue-600 text-white hover:bg-blue-700':'bg-slate-200 text-slate-500'}`}>Ø®Ø±ÛŒØ¯ ({r.cost})</button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function KitchenApp({ user }) {
            const [tab, setTab] = useState('plan');
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex gap-2 mb-6">
                        <button onClick={() => setTab('plan')} className={`flex-1 py-2 rounded-xl font-black border transition-colors ${tab === 'plan' ? 'bg-orange-500 text-white border-orange-500' : 'bg-white text-black border-slate-200'}`}>ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ù‡</button>
                        <button onClick={() => setTab('cook')} className={`flex-1 py-2 rounded-xl font-black border transition-colors ${tab === 'cook' ? 'bg-orange-500 text-white border-orange-500' : 'bg-white text-black border-slate-200'}`}>ğŸ“– Ø¯Ø³ØªÙˆØ±Ù¾Ø®Øª</button>
                        <button onClick={() => setTab('crave')} className={`flex-1 py-2 rounded-xl font-black border transition-colors ${tab === 'crave' ? 'bg-orange-500 text-white border-orange-500' : 'bg-white text-black border-slate-200'}`}>ğŸ˜‹ Ù‡ÙˆØ³â€ŒØ§Ù†Ú¯ÛŒØ²</button>
                    </div>
                    {tab === 'plan' && <WeeklyMealPlan />}
                    {tab === 'cook' && <Cookbook user={user} />}
                    {tab === 'crave' && <CravingsList user={user} />}
                </div>
            );
        }

        function WeeklyMealPlan() {
            const [meals, setMeals] = useState({});
            const week = ['Ø´Ù†Ø¨Ù‡', 'ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡'];
            useEffect(() => onSnapshot(collection(db, 'meals'), s => { const d={}; s.forEach(x=>d[x.id]=x.data()); setMeals(d); }), []);
            const up = (d, t, v) => setDoc(doc(db, 'meals', d), { ...meals[d], [t]: v }, { merge: true });
            return (
                <div className="space-y-3">{week.map(day => (
                    <div key={day} className="bg-white p-3 rounded-xl border flex flex-col md:flex-row gap-3 items-center">
                        <div className="w-20 font-black text-black">{day}</div>
                        <div className="flex-1 w-full grid grid-cols-2 gap-2">
                            <div className="bg-orange-50 p-2 rounded-lg flex gap-2 items-center"><Utensils size={14} className="text-orange-600"/><input value={meals[day]?.lunch||''} onChange={e=>up(day,'lunch',e.target.value)} placeholder="Ù†Ø§Ù‡Ø§Ø±" className="bg-transparent w-full text-sm outline-none text-black font-bold"/></div>
                            <div className="bg-indigo-50 p-2 rounded-lg flex gap-2 items-center"><UtensilsCrossed size={14} className="text-indigo-600"/><input value={meals[day]?.dinner||''} onChange={e=>up(day,'dinner',e.target.value)} placeholder="Ø´Ø§Ù…" className="bg-transparent w-full text-sm outline-none text-black font-bold"/></div>
                        </div>
                    </div>
                ))}</div>
            )
        }

        function Cookbook({ user }) {
            const [list, setList] = useState([]);
            const [n, setN] = useState({title:'',text:''});
            useEffect(() => onSnapshot(collection(db, 'recipes'), s => setList(s.docs.map(d=>({id:d.id,...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!n.title)return; await addDoc(collection(db,'recipes'),n); setN({title:'',text:''}); }
            return (
                <div className="space-y-4">
                    <form onSubmit={add} className="bg-white p-4 rounded-xl border space-y-2"><input value={n.title} onChange={e=>setN({...n,title:e.target.value})} placeholder="Ù†Ø§Ù… ØºØ°Ø§" className="w-full p-2 border rounded-lg text-black font-bold"/><textarea value={n.text} onChange={e=>setN({...n,text:e.target.value})} placeholder="Ø¯Ø³ØªÙˆØ±..." className="w-full p-2 border rounded-lg h-20 text-black"/><button className="bg-orange-500 text-white w-full py-2 rounded-lg font-bold">Ø«Ø¨Øª</button></form>
                    <div className="grid md:grid-cols-2 gap-4">{list.map(r=><div key={r.id} className="bg-white p-4 rounded-xl border relative"><h4 className="font-black text-black mb-2">{r.title}</h4><p className="text-sm whitespace-pre-wrap text-slate-800">{r.text}</p><button onClick={()=>deleteDoc(doc(db,'recipes',r.id))} className="absolute top-2 left-2 text-slate-300 hover:text-red-500"><Trash2 size={16}/></button></div>)}</div>
                </div>
            )
        }

        function CravingsList({ user }) {
            const [list, setList] = useState([]);
            const [t, setT] = useState('');
            useEffect(() => onSnapshot(collection(db, 'cravings'), s => setList(s.docs.map(d=>({id:d.id,...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!t)return; await addDoc(collection(db,'cravings'),{text:t,by:user.name}); setT(''); }
            return (
                <div className="space-y-4">
                    <form onSubmit={add} className="flex gap-2"><input value={t} onChange={e=>setT(e.target.value)} placeholder="Ù‡ÙˆØ³..." className="flex-1 p-3 border rounded-xl text-black font-bold"/><button className="bg-orange-500 text-white px-4 rounded-xl font-bold">+</button></form>
                    <div className="flex flex-wrap gap-2">{list.map(l=><div key={l.id} className="bg-white px-4 py-2 rounded-full border flex items-center gap-2 font-bold text-black"><span>{l.text}</span><span className="text-[10px] bg-slate-100 px-1 rounded text-slate-600">{l.by}</span><button onClick={()=>deleteDoc(doc(db,'cravings',l.id))} className="text-slate-300 hover:text-red-500">Ã—</button></div>)}</div>
                </div>
            )
        }

        function CalendarApp({ user }) {
            const [events, setEvents] = useState([]);
            const [newTitle, setNewTitle] = useState('');
            const [newDate, setNewDate] = useState('');

            useEffect(() => {
                const u1 = onSnapshot(query(collection(db, 'events'), orderBy('date', 'asc')), s => setEvents(s.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => u1();
            }, []);

            const addEvent = async (e) => { 
                e.preventDefault(); 
                if(!newTitle) return; 
                await addDoc(collection(db, 'events'), { 
                    title: newTitle, 
                    date: newDate, 
                    createdBy: user.name, 
                    createdAt: serverTimestamp() 
                }); 
                setNewTitle(''); 
                setNewDate(''); 
            }

            return (
                <div className="space-y-8">
                    <div>
                        <h3 className="font-black text-lg mb-4 flex items-center gap-2 text-black"><Calendar size={20} className="text-purple-600"/> Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ùˆ Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ú©ÙˆØ³</h3>
                        <form onSubmit={addEvent} className="bg-white p-2 rounded-2xl border shadow-sm flex flex-col md:flex-row gap-2 mb-4">
                            <input value={newTitle} onChange={e=>setNewTitle(e.target.value)} placeholder="Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ ØªÙˆÙ„Ø¯ Ø¨Ø§Ø¨Ø§)" className="flex-1 p-3 outline-none bg-transparent text-black font-bold border-b md:border-b-0 md:border-l"/>
                            <input type="date" value={newDate} onChange={e=>setNewDate(e.target.value)} className="md:w-48 p-3 outline-none text-sm text-black font-bold"/>
                            <button className="bg-purple-600 text-white px-6 py-2 md:py-0 rounded-xl font-bold hover:bg-purple-700 transition-colors">Ø§ÙØ²ÙˆØ¯Ù†</button>
                        </form>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {events.map(e => {
                                const daysLeft = getDaysUntilDate(e.date);
                                const isPassed = daysLeft !== null && daysLeft < 0;
                                return (
                                    <div key={e.id} className={`p-4 rounded-2xl border flex flex-col justify-between group relative overflow-hidden ${isPassed ? 'bg-slate-100 opacity-60' : 'bg-white hover:border-purple-300'}`}>
                                        <div className="flex justify-between items-start z-10 relative">
                                            <div>
                                                <p className="font-bold text-black text-lg">{e.title}</p>
                                                <p className="text-xs text-slate-500 mt-1">{e.date ? getPersianDate(e.date) : 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®'}</p>
                                            </div>
                                            <button onClick={()=>deleteDoc(doc(db,'events',e.id))} className="text-slate-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-all"><Trash2 size={16} /></button>
                                        </div>
                                        {daysLeft !== null && !isPassed && (
                                            <div className="mt-4 pt-4 border-t border-dashed border-slate-200">
                                                <div className="flex items-center gap-2 text-purple-700">
                                                    <Clock size={16} />
                                                    <span className="font-black text-2xl" dir="ltr">{daysLeft}</span>
                                                    <span className="text-xs font-bold">Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡</span>
                                                </div>
                                            </div>
                                        )}
                                        {isPassed && <div className="mt-2 text-xs text-red-500 font-bold">Ú¯Ø°Ø´ØªÙ‡ Ø§Ø³Øª</div>}
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                </div>
            )
        }

        function EntertainmentApp({ user }) {
            const [tab, setTab] = useState('timeline');
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex gap-2 mb-8 overflow-x-auto pb-2 px-1">
                        <button onClick={() => setTab('timeline')} className={`px-6 py-3 rounded-2xl font-black whitespace-nowrap transition-all border ${tab === 'timeline' ? 'bg-violet-600 text-white border-violet-600 shadow-lg shadow-violet-200' : 'bg-white text-black border-slate-200 hover:bg-violet-50'}`}>â³ Ø®Ø§Ø·Ø±Ø§Øª</button>
                        <button onClick={() => setTab('game')} className={`px-6 py-3 rounded-2xl font-black whitespace-nowrap transition-all border ${tab === 'game' ? 'bg-violet-600 text-white border-violet-600 shadow-lg shadow-violet-200' : 'bg-white text-black border-slate-200 hover:bg-violet-50'}`}>ğŸ® Ø¯ÙˆØ² Ø¨Ø§Ø²ÛŒ</button>
                        <button onClick={() => setTab('reviews')} className={`px-6 py-3 rounded-2xl font-black whitespace-nowrap transition-all border ${tab === 'reviews' ? 'bg-violet-600 text-white border-violet-600 shadow-lg shadow-violet-200' : 'bg-white text-black border-slate-200 hover:bg-violet-50'}`}>ğŸ¬ ÙÛŒÙ„Ù… Ùˆ Ú©ØªØ§Ø¨</button>
                    </div>
                    {tab === 'game' && <TicTacToe />}
                    {tab === 'reviews' && <Reviews user={user} />}
                    {tab === 'timeline' && <Timeline />}
                </div>
            );
        }

        function TicTacToe() {
            const [board, setBoard] = useState(Array(9).fill(null));
            const [xIsNext, setXIsNext] = useState(true);
            const winner = calculateWinner(board);

            function handleClick(i) {
                if (winner || board[i]) return;
                const nextBoard = board.slice();
                nextBoard[i] = xIsNext ? 'X' : 'O';
                setBoard(nextBoard);
                setXIsNext(!xIsNext);
            }

            function calculateWinner(squares) {
                const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
                for (let i = 0; i < lines.length; i++) {
                    const [a, b, c] = lines[i];
                    if (squares[a] && squares[a] === squares[b] && squares[a] === squares[c]) return squares[a];
                }
                return null;
            }

            return (
                <div className="flex flex-col items-center gap-6">
                    <div className="text-2xl font-black text-violet-800">
                        {winner ? `Ø¨Ø±Ù†Ø¯Ù‡: ${winner === 'X' ? 'âŒ' : 'â­•ï¸'}` : `Ù†ÙˆØ¨Øª: ${xIsNext ? 'âŒ' : 'â­•ï¸'}`}
                    </div>
                    <div className="grid grid-cols-3 gap-3 bg-violet-100 p-3 rounded-2xl">
                        {board.map((sq, i) => (
                            <button key={i} onClick={() => handleClick(i)} className="w-20 h-20 bg-white rounded-xl text-4xl font-black flex items-center justify-center shadow-sm hover:scale-105 transition-transform text-black">
                                {sq === 'X' ? <span className="text-rose-500">âŒ</span> : sq === 'O' ? <span className="text-blue-500">â­•ï¸</span> : ''}
                            </button>
                        ))}
                    </div>
                    <button onClick={() => setBoard(Array(9).fill(null))} className="bg-violet-600 text-white px-6 py-2 rounded-xl font-bold">Ø¨Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯</button>
                </div>
            )
        }

        function Timeline() {
            const [events, setEvents] = useState([]);
            const [year, setYear] = useState('');
            const [month, setMonth] = useState('');
            const [day, setDay] = useState('');
            const [title, setTitle] = useState('');
            useEffect(() => onSnapshot(collection(db, 'timeline'), s => {
                const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                data.sort((a,b) => {
                    if(Number(a.year) !== Number(b.year)) return Number(a.year) - Number(b.year);
                    if(Number(a.month) !== Number(b.month)) return Number(a.month) - Number(b.month);
                    return Number(a.day) - Number(b.day);
                });
                setEvents(data);
            }), []);
            const add = async (e) => { e.preventDefault(); if(!year || !month || !day || !title) return; await addDoc(collection(db, 'timeline'), { year: Number(year), month: Number(month), day: Number(day), title }); setTitle(''); };
            const months = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];
            return (
                <div className="space-y-8">
                     <form onSubmit={add} className="bg-white p-5 rounded-3xl border shadow-sm space-y-4">
                         <div className="grid grid-cols-3 gap-3">
                             <input type="number" value={day} onChange={e=>setDay(e.target.value)} placeholder="Ø±ÙˆØ²" className="p-3 border rounded-xl text-center outline-none focus:border-violet-500 transition-colors text-black font-bold"/>
                             <select value={month} onChange={e=>setMonth(e.target.value)} className="p-3 border rounded-xl text-center bg-white outline-none focus:border-violet-500 transition-colors text-black font-bold">
                                <option value="">Ù…Ø§Ù‡...</option>{months.map((m,i)=><option key={i} value={i+1}>{m}</option>)}
                             </select>
                             <input type="number" value={year} onChange={e=>setYear(e.target.value)} placeholder="Ø³Ø§Ù„" className="p-3 border rounded-xl text-center outline-none focus:border-violet-500 transition-colors text-black font-bold"/>
                         </div>
                         <div className="flex gap-2">
                             <input value={title} onChange={e=>setTitle(e.target.value)} placeholder="Ø®Ø§Ø·Ø±Ù‡ (Ù…ØªÙ† Ø¬ÙˆÚ© ÛŒØ§ Ø±ÙˆÛŒØ¯Ø§Ø¯)..." className="flex-1 p-3 border rounded-xl outline-none focus:border-violet-500 transition-colors text-black font-bold"/>
                             <button className="bg-violet-600 text-white px-6 rounded-xl font-bold hover:bg-violet-700 transition-colors">Ø«Ø¨Øª</button>
                         </div>
                     </form>
                     <div className="relative border-r-2 border-violet-200 mr-4 md:mr-10 space-y-8 py-4">
                        {events.length === 0 && <p className="text-slate-400 pr-8">Ù‡Ù†ÙˆØ² Ø±ÙˆÛŒØ¯Ø§Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡...</p>}
                        {events.map((e, i) => (
                            <div key={e.id} className="relative pr-8 group">
                                <div className="absolute -right-[9px] top-1.5 w-4 h-4 rounded-full bg-violet-500 ring-4 ring-slate-50 group-hover:scale-125 transition-transform"></div>
                                <div className="bg-white p-4 rounded-2xl border shadow-sm group-hover:shadow-md transition-all">
                                    <div className="flex justify-between items-start mb-1">
                                        <span className="text-xs font-bold text-violet-600 bg-violet-50 px-2 py-1 rounded-lg">{e.day} {months[e.month-1]} {e.year}</span>
                                        <button onClick={()=>deleteDoc(doc(db,'timeline',e.id))} className="text-slate-300 hover:text-red-500 transition-colors"><Trash2 size={14}/></button>
                                    </div>
                                    <h4 className="font-black text-lg text-black">{e.title}</h4>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )
        }

        function Reviews({ user }) {
            const [items, setItems] = useState([]);
            const [newI, setNewI] = useState({ title: '', type: 'movie', rate: '5' });
            useEffect(() => onSnapshot(query(collection(db, 'reviews'), orderBy('createdAt', 'desc')), s => setItems(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!newI.title)return; await addDoc(collection(db, 'reviews'), { ...newI, by: user.name, createdAt: serverTimestamp() }); setNewI({...newI, title: ''}); }
            return (
                <div className="space-y-4">
                    <form onSubmit={add} className="bg-white p-4 rounded-xl border flex gap-2 flex-wrap">
                        <select value={newI.type} onChange={e=>setNewI({...newI, type: e.target.value})} className="p-2 border rounded-lg bg-white text-black font-bold"><option value="movie">ÙÛŒÙ„Ù… ğŸ¬</option><option value="book">Ú©ØªØ§Ø¨ ğŸ“š</option></select>
                        <input value={newI.title} onChange={e=>setNewI({...newI, title: e.target.value})} placeholder="Ù†Ø§Ù… Ø§Ø«Ø±..." className="flex-1 p-2 border rounded-lg text-black font-bold" />
                        <select value={newI.rate} onChange={e=>setNewI({...newI, rate: e.target.value})} className="p-2 border rounded-lg bg-white text-black font-bold"><option>5</option><option>4</option><option>3</option><option>2</option><option>1</option></select>
                        <button className="bg-violet-600 text-white px-4 rounded-lg font-bold">+</button>
                    </form>
                    <div className="space-y-2">{items.map(i => (<div key={i.id} className="bg-white p-3 rounded-xl border flex justify-between items-center"><div className="flex items-center gap-3"><div className="text-2xl">{i.type === 'movie' ? 'ğŸ¬' : 'ğŸ“š'}</div><div><h4 className="font-bold text-black">{i.title}</h4><p className="text-xs text-slate-500">{i.by} â€¢ {i.rate} â­</p></div></div><button onClick={()=>deleteDoc(doc(db,'reviews',i.id))}><Trash2 size={16} className="text-slate-300"/></button></div>))}</div>
                </div>
            )
        }

        function FinanceApp({ user }) {
             const [list, setList] = useState([]);
             const [amt, setAmt] = useState('');
             const [desc, setDesc] = useState('');
             const [type, setType] = useState('expense');
             useEffect(() => onSnapshot(query(collection(db, 'finance'), orderBy('createdAt', 'desc')), s => setList(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
             const add = async (e) => { e.preventDefault(); if(!amt)return; await addDoc(collection(db, 'finance'), { amount: parseInt(amt), description: desc, type, createdAt: serverTimestamp() }); setAmt(''); setDesc(''); }
             return (
                 <div className="space-y-4">
                     <form onSubmit={add} className="bg-white p-4 rounded-xl border space-y-2">
                         <div className="flex gap-2"><button type="button" onClick={()=>setType('expense')} className={`flex-1 py-1 rounded font-bold ${type==='expense'?'bg-rose-100 text-rose-600':'bg-slate-50 text-black'}`}>Ù‡Ø²ÛŒÙ†Ù‡</button><button type="button" onClick={()=>setType('income')} className={`flex-1 py-1 rounded font-bold ${type==='income'?'bg-emerald-100 text-emerald-600':'bg-slate-50 text-black'}`}>Ø¯Ø±Ø¢Ù…Ø¯</button></div>
                         <input type="number" value={amt} onChange={e=>setAmt(e.target.value)} placeholder="Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)" className="w-full p-2 border rounded-lg text-black font-bold"/>
                         <input value={desc} onChange={e=>setDesc(e.target.value)} placeholder="Ø¨Ø§Ø¨Øª..." className="w-full p-2 border rounded-lg text-black font-bold"/>
                         <button className="bg-emerald-600 text-white w-full py-2 rounded-lg font-bold">Ø«Ø¨Øª</button>
                     </form>
                     <div className="space-y-2">{list.map(i => <div key={i.id} className="bg-white p-3 rounded-xl border flex justify-between"><span className="text-black font-bold">{i.description}</span><div className="flex items-center gap-2"><span className={`font-black ${i.type==='expense'?'text-rose-600':'text-emerald-600'}`}>{i.amount.toLocaleString()}</span><button onClick={()=>deleteDoc(doc(db,'finance',i.id))}><Trash2 size={14} className="text-slate-300"/></button></div></div>)}</div>
                 </div>
             )
        }

        function HouseApp({ user }) {
            const [tab, setTab] = useState('rules');
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex gap-2 mb-6">
                        <button onClick={() => setTab('rules')} className={`flex-1 py-2 rounded-xl font-black border transition-colors ${tab === 'rules' ? 'bg-slate-600 text-white border-slate-600' : 'bg-white text-black border-slate-200'}`}>ğŸ“œ Ù‚ÙˆØ§Ù†ÛŒÙ†</button>
                        <button onClick={() => setTab('repair')} className={`flex-1 py-2 rounded-xl font-black border transition-colors ${tab === 'repair' ? 'bg-slate-600 text-white border-slate-600' : 'bg-white text-black border-slate-200'}`}>ğŸ”§ ØªØ¹Ù…ÛŒØ±Ø§Øª</button>
                        <button onClick={() => setTab('contacts')} className={`flex-1 py-2 rounded-xl font-black border transition-colors ${tab === 'contacts' ? 'bg-slate-600 text-white border-slate-600' : 'bg-white text-black border-slate-200'}`}>ğŸ“ ØªÙ„ÙÙ†â€ŒÙ‡Ø§</button>
                    </div>
                    {tab === 'rules' && <HouseRules />}
                    {tab === 'repair' && <RepairApp />}
                    {tab === 'contacts' && <ContactsApp />}
                </div>
            )
        }

        function HouseRules() {
            const [list, setList] = useState([]);
            const [t, setT] = useState('');
            useEffect(() => onSnapshot(query(collection(db, 'rules'), orderBy('createdAt', 'desc')), s => setList(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!t)return; await addDoc(collection(db, 'rules'), { text: t, createdAt: serverTimestamp() }); setT(''); }
            return (
                <div className="space-y-4">
                    <form onSubmit={add} className="flex gap-2"><input value={t} onChange={e=>setT(e.target.value)} placeholder="Ù‚Ø§Ù†ÙˆÙ† Ø¬Ø¯ÛŒØ¯..." className="flex-1 p-2 border rounded-lg text-black font-bold"/><button className="bg-slate-600 text-white px-4 rounded-lg font-bold">+</button></form>
                    <ul className="bg-white p-6 rounded-2xl border space-y-3">{list.map(r => <li key={r.id} className="flex justify-between items-center bg-slate-50 p-2 rounded-lg"><div className="flex gap-2 items-center"><div className="w-2 h-2 rounded-full bg-slate-400"></div><span className="text-black font-bold">{r.text}</span></div><button onClick={()=>deleteDoc(doc(db,'rules',r.id))}><Trash2 size={14} className="text-slate-300"/></button></li>)}</ul>
                </div>
            )
        }

        function RepairApp() {
            const [list, setList] = useState([]);
            const [t, setT] = useState('');
            useEffect(() => onSnapshot(collection(db, 'repair'), s => setList(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!t)return; await addDoc(collection(db, 'repair'), { text: t }); setT(''); }
            return (
                <div className="space-y-4">
                    <form onSubmit={add} className="flex gap-2"><input value={t} onChange={e=>setT(e.target.value)} placeholder="Ø®Ø±Ø§Ø¨ÛŒ..." className="flex-1 p-2 border rounded-lg text-black font-bold"/><button className="bg-slate-600 text-white px-4 rounded-lg font-bold">+</button></form>
                    <div className="space-y-2">{list.map(i => <div key={i.id} className="bg-white p-3 rounded-xl border flex justify-between"><span className="text-black font-bold">{i.text}</span><button onClick={()=>deleteDoc(doc(db,'repair',i.id))}><Trash2 size={14} className="text-slate-300"/></button></div>)}</div>
                </div>
            )
        }

        function ContactsApp() {
            const [list, setList] = useState([]);
            const [n, setN] = useState(''); const [p, setP] = useState('');
            useEffect(() => onSnapshot(query(collection(db, 'contacts'), orderBy('createdAt', 'desc')), s => setList(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!n)return; await addDoc(collection(db, 'contacts'), { name: n, phone: p, createdAt: serverTimestamp() }); setN(''); setP(''); }
            return (
                <div className="space-y-4">
                    <form onSubmit={add} className="flex gap-2"><input value={n} onChange={e=>setN(e.target.value)} placeholder="Ù†Ø§Ù…" className="flex-1 p-2 border rounded-lg text-black font-bold"/><input value={p} onChange={e=>setP(e.target.value)} placeholder="Ø´Ù…Ø§Ø±Ù‡" className="w-1/3 p-2 border rounded-lg text-black font-bold" dir="ltr"/><button className="bg-green-600 text-white px-4 rounded-lg font-bold">+</button></form>
                    <div className="grid sm:grid-cols-2 gap-4">{list.map(c => <div key={c.id} className="bg-white p-4 rounded-xl border flex justify-between items-center"><div className="flex gap-3 items-center"><Phone className="text-green-500" size={20}/><div><div className="text-sm text-slate-500 font-bold">{c.name}</div><div className="text-lg font-black text-black" dir="ltr">{c.phone}</div></div></div><button onClick={()=>deleteDoc(doc(db,'contacts',c.id))}><Trash2 size={16} className="text-slate-300"/></button></div>)}</div>
                </div>
            )
        }

        function HealthApp({ user }) {
            const [list, setList] = useState([]);
            const [t, setT] = useState('');
            useEffect(() => onSnapshot(collection(db, 'medications'), s => setList(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const add = async (e) => { e.preventDefault(); if(!t)return; await addDoc(collection(db, 'medications'), { name: t }); setT(''); }
            return (
                 <div className="space-y-4">
                     <form onSubmit={add} className="flex gap-2"><input value={t} onChange={e=>setT(e.target.value)} placeholder="Ø¯Ø§Ø±Ùˆ..." className="flex-1 p-2 border rounded-lg text-black font-bold"/><button className="bg-red-500 text-white px-4 rounded-lg font-bold">+</button></form>
                     <div className="space-y-2">{list.map(i => <div key={i.id} className="bg-white p-3 rounded-xl border flex justify-between"><span className="text-black font-bold">{i.name}</span><button onClick={()=>deleteDoc(doc(db,'medications',i.id))}><Trash2 size={14} className="text-slate-300"/></button></div>)}</div>
                 </div>
            )
        }

        function ChatApp({ user }) {
            const [msgs, setMsgs] = useState([]);
            const [txt, setTxt] = useState('');
            useEffect(() => onSnapshot(query(collection(db, 'messages'), orderBy('createdAt', 'asc')), s => setMsgs(s.docs.map(d => ({id: d.id, ...d.data()})))), []);
            const send = async (e) => { e.preventDefault(); if(!txt)return; await addDoc(collection(db, 'messages'), { text: txt, sender: user.name, senderId: user.id, createdAt: serverTimestamp() }); setTxt(''); }
            return (
                <div className="flex flex-col h-[70vh] bg-white rounded-2xl border overflow-hidden">
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">{msgs.map(m => <div key={m.id} className={`flex flex-col ${m.senderId===user.id?'items-end':'items-start'}`}><div className={`px-4 py-2 rounded-2xl max-w-[85%] text-sm font-bold ${m.senderId===user.id?'bg-teal-600 text-white rounded-br-none':'bg-white border rounded-bl-none text-black'}`}>{m.text}</div><span className="text-[10px] text-slate-500 px-1 font-bold">{m.sender}</span></div>)}</div>
                    <form onSubmit={send} className="p-2 border-t flex gap-2"><input value={txt} onChange={e=>setTxt(e.target.value)} className="flex-1 px-4 py-2 bg-slate-100 rounded-xl outline-none text-black font-bold" placeholder="..." /><button className="bg-teal-600 text-white p-2 rounded-xl"><ArrowUpCircle/></button></form>
                </div>
            )
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<FamilyOS />);
    </script>
</body>
</html>
